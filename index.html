<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <title>BeeTrack ‚Äì Rastreador de Ninhos</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />

    <!-- Estilos b√°sicos -->
    <style>
      :root {
        --green: #166534;
        --green-dark: #14532d;
        --green-light: #22c55e;
        --bg: #0f172a;
        --bg-card: #020617;
        --border: #1e293b;
        --text: #e5e7eb;
        --muted: #9ca3af;
        --accent: #facc15;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
          sans-serif;
        background: radial-gradient(circle at top, #1e293b, #020617 55%);
        color: var(--text);
        min-height: 100vh;
        display: flex;
        flex-direction: column;
      }

      header {
        padding: 12px 16px;
        border-bottom: 1px solid #1f2933;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
      }

      .brand {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .brand-icon {
        width: 32px;
        height: 32px;
        border-radius: 999px;
        background: radial-gradient(circle at 30% 20%, #fde68a, #f97316);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 18px;
      }

      .brand-title {
        display: flex;
        flex-direction: column;
        line-height: 1.1;
      }

      .brand-title strong {
        font-size: 18px;
      }

      .brand-title span {
        font-size: 12px;
        color: var(--muted);
      }

      .status-cloud {
        font-size: 12px;
        color: var(--muted);
        display: flex;
        align-items: center;
        gap: 6px;
      }

      .status-dot {
        width: 8px;
        height: 8px;
        border-radius: 999px;
        background: #16a34a;
      }

      main {
        flex: 1;
        display: flex;
        flex-direction: column;
      }

      .app-layout {
        flex: 1;
        display: grid;
        grid-template-columns: minmax(0, 380px) minmax(0, 1fr);
        gap: 10px;
        padding: 10px;
      }

      /* Painel esquerdo */
      .left-panel {
        display: flex;
        flex-direction: column;
        gap: 10px;
      }

      .card {
        background: rgba(15, 23, 42, 0.98);
        border-radius: 12px;
        border: 1px solid var(--border);
        padding: 12px 14px;
        box-shadow: 0 18px 40px rgba(0, 0, 0, 0.45);
      }

      .card h2 {
        margin: 0 0 4px;
        font-size: 16px;
        display: flex;
        align-items: center;
        gap: 6px;
      }

      .card p {
        margin: 0;
        font-size: 13px;
        color: var(--muted);
      }

      .badge {
        font-size: 11px;
        padding: 2px 6px;
        border-radius: 999px;
        border: 1px solid rgba(148, 163, 184, 0.4);
        color: var(--muted);
      }

      .controls-row {
        margin-top: 10px;
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
      }

      .btn-primary,
      .btn-outline {
        border-radius: 999px;
        border: none;
        cursor: pointer;
        padding: 8px 14px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
        font-size: 13px;
        font-weight: 500;
        transition: all 0.15s ease;
        white-space: nowrap;
      }

      .btn-primary {
        background: linear-gradient(135deg, var(--green), var(--green-light));
        color: white;
      }

      .btn-primary:hover {
        filter: brightness(1.05);
        transform: translateY(-1px);
      }

      .btn-outline {
        background: transparent;
        border: 1px solid rgba(148, 163, 184, 0.7);
        color: var(--text);
      }

      .btn-outline:hover {
        border-color: #e5e7eb;
        transform: translateY(-1px);
      }

      .btn-small {
        padding: 4px 8px;
        font-size: 11px;
      }

      .pill {
        border-radius: 999px;
        padding: 4px 8px;
        font-size: 12px;
        background: rgba(15, 23, 42, 0.9);
        border: 1px solid rgba(148, 163, 184, 0.5);
        display: inline-flex;
        align-items: center;
        gap: 6px;
      }

      .pill span {
        font-size: 11px;
        color: var(--muted);
      }

      /* Login */
      .auth-card {
        margin-top: 6px;
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .auth-row {
        display: flex;
        flex-direction: column;
        gap: 6px;
      }

      label {
        font-size: 12px;
        color: var(--muted);
      }

      input[type="email"],
      input[type="password"] {
        width: 100%;
        border-radius: 999px;
        border: 1px solid rgba(148, 163, 184, 0.6);
        background: rgba(15, 23, 42, 0.9);
        padding: 7px 10px;
        color: var(--text);
        font-size: 13px;
      }

      input:focus {
        outline: 1px solid #22c55e;
        border-color: #22c55e;
      }

      .auth-buttons {
        display: flex;
        gap: 6px;
        margin-top: 6px;
      }

      .auth-message {
        font-size: 12px;
        margin-top: 4px;
      }

      .auth-message.error {
        color: #fecaca;
      }

      .auth-message.success {
        color: #bbf7d0;
      }

      .logout-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 6px;
        font-size: 12px;
        color: var(--muted);
      }

      /* Lista de trajetos / ninhos */
      .list {
        margin-top: 8px;
        max-height: 230px;
        overflow-y: auto;
        padding-right: 6px;
      }

      .route-item {
        border-radius: 10px;
        border: 1px solid rgba(51, 65, 85, 0.8);
        padding: 8px 9px;
        font-size: 12px;
        margin-bottom: 6px;
        background: rgba(15, 23, 42, 0.9);
        display: flex;
        flex-direction: column;
        gap: 6px;
      }

      .route-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 8px;
      }

      .route-name {
        font-weight: 500;
      }

      .route-meta {
        font-size: 11px;
        color: var(--muted);
      }

      .route-actions {
        display: flex;
        gap: 4px;
      }

      .chip {
        border-radius: 999px;
        padding: 3px 8px;
        font-size: 11px;
        background: rgba(15, 23, 42, 0.9);
        border: 1px solid rgba(148, 163, 184, 0.4);
        display: inline-flex;
        align-items: center;
        gap: 4px;
      }

      .chip-dot {
        width: 8px;
        height: 8px;
        border-radius: 999px;
        background: var(--accent);
      }

      .nest-photo {
        width: 44px;
        height: 44px;
        border-radius: 10px;
        object-fit: cover;
        cursor: pointer;
        border: 1px solid #334155;
      }

      .nests-grid {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-top: 8px;
      }

      .nests-empty {
        font-size: 12px;
        color: var(--muted);
        margin-top: 4px;
      }

      /* Mapa */
      #map {
        width: 100%;
        height: 100%;
        border-radius: 12px;
        border: 1px solid var(--border);
        overflow: hidden;
      }

      .map-wrapper {
        background: #020617;
        border-radius: 12px;
        border: 1px solid var(--border);
        padding: 6px;
      }

      .map-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 4px;
      }

      .map-header h2 {
        margin: 0;
        font-size: 14px;
        color: #e5e7eb;
      }

      .map-subtitle {
        font-size: 12px;
        color: var(--muted);
      }

      .toggle-btn {
        border-radius: 999px;
        border: 1px solid rgba(148, 163, 184, 0.6);
        padding: 4px 8px;
        font-size: 11px;
        background: rgba(15, 23, 42, 0.9);
        color: var(--muted);
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        gap: 4px;
      }

      .toggle-btn span {
        font-size: 13px;
      }

      /* Modal de foto */
      .modal-backdrop {
        position: fixed;
        inset: 0;
        background: rgba(15, 23, 42, 0.88);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 40;
      }

      .modal-backdrop.open {
        display: flex;
      }

      .modal-photo {
        max-width: min(90vw, 480px);
        max-height: 80vh;
        border-radius: 16px;
        box-shadow: 0 25px 60px rgba(0, 0, 0, 0.65);
        border: 1px solid #64748b;
      }

      .modal-close {
        position: absolute;
        top: 14px;
        right: 14px;
        border-radius: 999px;
        border: none;
        background: rgba(15, 23, 42, 0.9);
        color: #e5e7eb;
        padding: 6px 10px;
        font-size: 12px;
        cursor: pointer;
      }

      @media (max-width: 880px) {
        .app-layout {
          grid-template-columns: minmax(0, 1fr);
        }

        .left-panel {
          order: 2;
        }
      }
    </style>

    <!-- Leaflet -->
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
      crossorigin=""
    />
    <script
      src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
      integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
      crossorigin=""
    ></script>

    <!-- Supabase JS v2 -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  </head>

  <body>
    <header>
      <div class="brand">
        <div class="brand-icon">üêù</div>
        <div class="brand-title">
          <strong>BeeTrack</strong>
          <span>Rastreador de ninhos de abelhas</span>
        </div>
      </div>
      <div class="status-cloud" id="cloud-status">
        <span class="status-dot"></span>
        Conectado √† nuvem (Supabase)
      </div>
    </header>

    <main>
      <div class="app-layout">
        <!-- Painel esquerdo -->
        <section class="left-panel">
          <!-- Bloco de autentica√ß√£o -->
          <div class="card">
            <h2>
              Acesso
              <span class="badge">Login necess√°rio</span>
            </h2>
            <p>
              Entre com e-mail e senha ou use Google para salvar seus trajetos
              na nuvem.
            </p>

            <div id="auth-section" class="auth-card">
              <div class="auth-row">
                <label for="auth-email">E-mail</label>
                <input
                  id="auth-email"
                  type="email"
                  placeholder="seuemail@exemplo.com"
                />
              </div>
              <div class="auth-row">
                <label for="auth-password">Senha</label>
                <input
                  id="auth-password"
                  type="password"
                  placeholder="M√≠nimo 6 caracteres"
                />
              </div>
              <div class="auth-buttons">
                <button class="btn-primary" id="btn-signin">
                  Entrar
                </button>
                <button class="btn-outline" id="btn-signup">
                  Criar conta
                </button>
              </div>
              <div
                class="auth-buttons"
                style="margin-top: 6px; flex-direction: column"
              >
                <button
                  class="btn-outline"
                  id="btn-google"
                  style="width: 100%"
                >
                  <span>üîê</span> Entrar com Google
                </button>
              </div>
              <div id="auth-message" class="auth-message"></div>
            </div>

            <div id="logout-section" style="display: none">
              <div class="logout-row">
                <span>
                  Logado como
                  <strong id="current-user-email"></strong>
                </span>
                <button class="btn-outline btn-small" id="btn-logout">
                  Sair
                </button>
              </div>
            </div>
          </div>

          <!-- Controle de trajeto -->
          <div class="card">
            <h2>
              Controle de trajeto
              <span class="badge">Modo campo</span>
            </h2>
            <p>
              Grave o caminho, marque ninhos com foto e consulte depois na
              ordem correta.
            </p>

            <div class="controls-row">
              <button class="btn-primary" id="btn-toggle-route">
                ‚ñ∂Ô∏è Iniciar trajeto
              </button>

              <button class="btn-outline" id="btn-add-nest" disabled>
                üìç Marcar ninho com foto
              </button>
            </div>

            <div style="margin-top: 8px; font-size: 12px; color: var(--muted)">
              <div id="current-route-info">Trajeto inativo.</div>
              <div id="gps-status" style="margin-top: 4px">
                ‚è±Ô∏è Aguardando GPS‚Ä¶
              </div>
            </div>
          </div>

          <!-- Lista de trajetos gravados -->
          <div class="card">
            <h2>Trajetos salvos</h2>
            <p>
              Toque em um trajeto para ver no mapa; monitore ninhos na mesma
              sequ√™ncia em que foram marcados.
            </p>
            <div class="list" id="routes-list"></div>
            <div
              id="routes-empty"
              class="nests-empty"
              style="display: none; margin-top: 6px"
            >
              Nenhum trajeto salvo ainda.
            </div>
          </div>

          <!-- Ninhos do trajeto selecionado -->
          <div class="card">
            <h2>Ninhos do trajeto</h2>
            <p>
              Visualize as fotos e localiza√ß√£o dos ninhos marcados no trajeto
              selecionado.
            </p>
            <div class="nests-grid" id="nests-grid"></div>
            <div id="nests-empty" class="nests-empty">
              Selecione um trajeto para ver os ninhos.
            </div>
          </div>
        </section>

        <!-- Mapa -->
        <section class="map-wrapper">
          <div class="map-header">
            <div>
              <h2>Mapa de campo</h2>
              <div class="map-subtitle">
                Arraste, d√™ zoom e acompanhe o caminho em tempo real.
              </div>
            </div>
            <button class="toggle-btn" id="btn-toggle-sidebar">
              <span>üß≠</span> Focar no mapa
            </button>
          </div>
          <div id="map"></div>
        </section>
      </div>
    </main>

    <!-- Modal de foto -->
    <div id="photo-modal" class="modal-backdrop">
      <button class="modal-close" id="photo-modal-close">Fechar</button>
      <img id="photo-modal-img" class="modal-photo" src="" alt="Foto do ninho" />
    </div>

    <!-- L√≥gica principal -->
    <script>
      // ========= CONFIGURA√á√ÉO SUPABASE =========
      const SUPABASE_URL = "https://sgrtyotwnlwpwfecnoze.supabase.co"; // ex.: https://xxxx.supabase.co
      const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNncnR5b3R3bmx3cHdmZWNub3plIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc3NjgxMjcsImV4cCI6MjA4MzM0NDEyN30.QZvTN3mHUwqBwvXeL6q89qNW_4s1Cvopa40nt4TFa9w";

      const supabaseClient = supabase.createClient(
        SUPABASE_URL,
        SUPABASE_ANON_KEY
      );

      // ========= ELEMENTOS =========
      const authSection = document.getElementById("auth-section");
      const logoutSection = document.getElementById("logout-section");
      const authEmailInput = document.getElementById("auth-email");
      const authPasswordInput = document.getElementById("auth-password");
      const authMessageEl = document.getElementById("auth-message");
      const currentUserEmailEl = document.getElementById("current-user-email");

      const btnSignIn = document.getElementById("btn-signin");
      const btnSignUp = document.getElementById("btn-signup");
      const btnGoogle = document.getElementById("btn-google");
      const btnLogout = document.getElementById("btn-logout");

      const btnToggleRoute = document.getElementById("btn-toggle-route");
      const btnAddNest = document.getElementById("btn-add-nest");
      const currentRouteInfoEl = document.getElementById(
        "current-route-info"
      );
      const gpsStatusEl = document.getElementById("gps-status");

      const routesListEl = document.getElementById("routes-list");
      const routesEmptyEl = document.getElementById("routes-empty");
      const nestsGridEl = document.getElementById("nests-grid");
      const nestsEmptyEl = document.getElementById("nests-empty");

      const cloudStatusEl = document.getElementById("cloud-status");
      const btnToggleSidebar = document.getElementById("btn-toggle-sidebar");

      const photoModal = document.getElementById("photo-modal");
      const photoModalImg = document.getElementById("photo-modal-img");
      const photoModalClose = document.getElementById("photo-modal-close");

      // ========= ESTADO =========
      let map;
      let currentMarker = null;
      let pathPolyline = null;
      let watchId = null;
      let recording = false;
      let currentRoute = null; // {id,name,path:[],traps:[]}
      let routesCache = []; // rotas vindas do Supabase

      // ========= FUN√á√ïES AUX auth =========
      function setAuthMessage(msg, isError = false, isSuccess = false) {
        authMessageEl.textContent = msg || "";
        authMessageEl.className = "auth-message";
        if (isError) authMessageEl.classList.add("error");
        else if (isSuccess) authMessageEl.classList.add("success");
      }

      function setLoggedInUI(user) {
        if (user) {
          authSection.style.display = "none";
          logoutSection.style.display = "block";
          currentUserEmailEl.textContent = user.email || "conta Google";
        } else {
          authSection.style.display = "block";
          logoutSection.style.display = "none";
          currentUserEmailEl.textContent = "";
        }
      }

      async function handleSignUp() {
        const email = authEmailInput.value.trim();
        const password = authPasswordInput.value.trim();
        if (!email || !password) {
          setAuthMessage("Informe e-mail e senha.", true);
          return;
        }
        setAuthMessage("Criando conta...");
        const { data, error } = await supabaseClient.auth.signUp({
          email,
          password,
        });
        if (error) {
          console.error(error);
          setAuthMessage(
            error.message || "N√£o foi poss√≠vel criar a conta.",
            true
          );
          return;
        }
        setAuthMessage(
          "Conta criada. Verifique seu e-mail (se a verifica√ß√£o estiver habilitada) e depois fa√ßa login.",
          false,
          true
        );
      }

      async function handleSignIn() {
        const email = authEmailInput.value.trim();
        const password = authPasswordInput.value.trim();
        if (!email || !password) {
          setAuthMessage("Informe e-mail e senha.", true);
          return;
        }
        setAuthMessage("Entrando...");
        const { data, error } = await supabaseClient.auth.signInWithPassword({
          email,
          password,
        });
        if (error) {
          console.error(error);
          setAuthMessage(
            error.message || "N√£o foi poss√≠vel fazer login.",
            true
          );
          return;
        }
        setAuthMessage("Login realizado!", false, true);
        await refreshSessionAndData();
      }

      async function handleSignInWithGoogle() {
        setAuthMessage("Redirecionando para Google...");
        const { data, error } = await supabaseClient.auth.signInWithOAuth({
          provider: "google",
          options: {
            redirectTo: window.location.origin,
          },
        });
        if (error) {
          console.error(error);
          setAuthMessage(
            error.message || "Erro ao redirecionar para Google.",
            true
          );
        }
        // O Supabase redireciona, ent√£o n√£o precisa fazer nada aqui.
      }

      async function handleLogout() {
        await supabaseClient.auth.signOut();
        setLoggedInUI(null);
        routesCache = [];
        renderRoutesList();
        nestsGridEl.innerHTML = "";
        nestsEmptyEl.textContent = "Selecione um trajeto para ver os ninhos.";
      }

      async function refreshSessionAndData() {
        const {
          data: { session },
        } = await supabaseClient.auth.getSession();
        const user = session?.user ?? null;
        setLoggedInUI(user);
        if (user) {
          await loadRoutesFromSupabase();
        }
      }

      // ========= Rotas + Supabase =========
      async function loadRoutesFromSupabase() {
        try {
          const { data, error } = await supabaseClient
            .from("routes")
            .select("*")
            .order("created_at", { ascending: false });

          if (error) throw error;
          routesCache = data || [];
          renderRoutesList();
        } catch (err) {
          console.error("Erro ao carregar rotas:", err);
          routesCache = [];
          renderRoutesList();
        }
      }

      async function saveRouteToSupabase(route) {
        // route: { name, path, traps }
        try {
          const { data, error } = await supabaseClient
            .from("routes")
            .insert({
              name: route.name,
              path: route.path,
              traps: route.traps,
            })
            .select()
            .single();
          if (error) throw error;
          routesCache.unshift(data);
          renderRoutesList();
          alert("Trajeto salvo na nuvem com sucesso!");
        } catch (err) {
          console.error("Erro ao salvar trajeto na nuvem:", err);
          alert(
            "Erro ao salvar trajeto na nuvem. Ele ficar√° apenas neste aparelho."
          );
        }
      }

      async function updateRouteName(routeId, newName) {
        try {
          const { data, error } = await supabaseClient
            .from("routes")
            .update({ name: newName })
            .eq("id", routeId)
            .select()
            .single();
          if (error) throw error;

          const idx = routesCache.findIndex((r) => r.id === routeId);
          if (idx >= 0) routesCache[idx] = data;
          renderRoutesList();
        } catch (err) {
          console.error("Erro ao renomear trajeto:", err);
          alert("N√£o foi poss√≠vel renomear o trajeto.");
        }
      }

      async function deleteRoute(routeId) {
        if (!confirm("Tem certeza que deseja excluir este trajeto?")) return;
        try {
          await supabaseClient.from("routes").delete().eq("id", routeId);
          routesCache = routesCache.filter((r) => r.id !== routeId);
          renderRoutesList();
          nestsGridEl.innerHTML = "";
          nestsEmptyEl.textContent = "Selecione um trajeto para ver os ninhos.";
        } catch (err) {
          console.error("Erro ao excluir trajeto:", err);
          alert("N√£o foi poss√≠vel excluir o trajeto.");
        }
      }

      // ========= Storage (fotos) =========
      async function uploadNestPhoto(routeId, trapId, dataUrl) {
        // converte dataURL em Blob
        const res = await fetch(dataUrl);
        const blob = await res.blob();
        const ext = "jpg";
        const path = `${routeId || "sem-id"}/${trapId}.${ext}`;

        const bucket = supabaseClient.storage.from("ninhos-fotos");

        const { error: uploadError } = await bucket.upload(path, blob, {
          upsert: true,
          contentType: blob.type || "image/jpeg",
        });
        if (uploadError) {
          console.error("Erro ao enviar foto:", uploadError);
          throw uploadError;
        }

        const { data: publicData } = bucket.getPublicUrl(path);
        return publicData.publicUrl;
      }

      // ========= RENDERIZA√á√ÉO =========
      function renderRoutesList() {
        routesListEl.innerHTML = "";
        if (!routesCache.length) {
          routesEmptyEl.style.display = "block";
          return;
        }
        routesEmptyEl.style.display = "none";

        for (const route of routesCache) {
          const item = document.createElement("div");
          item.className = "route-item";

          const header = document.createElement("div");
          header.className = "route-header";

          const nameEl = document.createElement("div");
          nameEl.className = "route-name";
          nameEl.textContent = route.name || "Trajeto sem nome";

          const actions = document.createElement("div");
          actions.className = "route-actions";

          const btnMonitor = document.createElement("button");
          btnMonitor.className = "btn-primary btn-small";
          btnMonitor.textContent = "Monitorar ninhos";
          btnMonitor.addEventListener("click", () => {
            focusRouteOnMap(route);
            renderNests(route);
          });

          const btnRename = document.createElement("button");
          btnRename.className = "btn-outline btn-small";
          btnRename.textContent = "Renomear";
          btnRename.addEventListener("click", () => {
            const newName = prompt("Novo nome para o trajeto:", route.name);
            if (newName && newName.trim()) {
              updateRouteName(route.id, newName.trim());
            }
          });

          const btnDelete = document.createElement("button");
          btnDelete.className = "btn-outline btn-small";
          btnDelete.textContent = "Excluir";
          btnDelete.addEventListener("click", () => deleteRoute(route.id));

          actions.append(btnMonitor, btnRename, btnDelete);
          header.append(nameEl, actions);

          const meta = document.createElement("div");
          meta.className = "route-meta";
          const dataStr = route.created_at
            ? new Date(route.created_at).toLocaleString("pt-BR")
            : "";
          const qtdNinhos = (route.traps || []).length;
          meta.textContent = `${dataStr} ‚Ä¢ ${qtdNinhos} ninhos`;

          item.append(header, meta);
          routesListEl.appendChild(item);
        }
      }

      function renderNests(route) {
        nestsGridEl.innerHTML = "";
        const traps = route.traps || [];
        if (!traps.length) {
          nestsEmptyEl.textContent =
            "Este trajeto ainda n√£o possui ninhos marcados.";
          return;
        }
        nestsEmptyEl.textContent = "";

        traps.forEach((trap, idx) => {
          const img = document.createElement("img");
          img.className = "nest-photo";
          img.src = trap.photoUrl || trap.photo || "";
          img.alt = `Ninho ${idx + 1}`;
          img.addEventListener("click", () => {
            if (!img.src) return;
            photoModalImg.src = img.src;
            photoModal.classList.add("open");
          });
          nestsGridEl.appendChild(img);
        });
      }

      // ========= GEOLocaliza√ß√£o e mapa =========
      function initMap() {
        map = L.map("map");
        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
          maxZoom: 19,
          attribution: "&copy; OpenStreetMap",
        }).addTo(map);

        // Tentar centralizar no usu√°rio
        navigator.geolocation.getCurrentPosition(
          (pos) => {
            const lat = pos.coords.latitude;
            const lng = pos.coords.longitude;
            map.setView([lat, lng], 17);
          },
          () => {
            map.setView([-15.601, -56.097], 13); // fallback gen√©rico
          }
        );
      }

      function startRecording() {
        if (!navigator.geolocation) {
          alert("Seu dispositivo n√£o suporta geolocaliza√ß√£o.");
          return;
        }

        const name = prompt("Nome do trajeto:", "Nova trajet√≥ria");
        if (!name) return;

        recording = true;
        currentRoute = {
          name,
          path: [],
          traps: [],
        };
        currentRouteInfoEl.textContent = `Gravando: ${name}`;
        btnToggleRoute.textContent = "‚èπÔ∏è Encerrar trajeto";
        btnAddNest.disabled = false;
        gpsStatusEl.textContent = "Grava√ß√£o iniciada. Movimente-se com o app aberto.";

        if (pathPolyline) {
          map.removeLayer(pathPolyline);
          pathPolyline = null;
        }

        watchId = navigator.geolocation.watchPosition(
          (pos) => {
            const { latitude, longitude } = pos.coords;
            const point = [latitude, longitude];
            currentRoute.path.push({
              lat: latitude,
              lng: longitude,
              ts: Date.now(),
            });

            if (!currentMarker) {
              currentMarker = L.marker(point).addTo(map);
              map.setView(point, 18);
            } else {
              currentMarker.setLatLng(point);
            }

            if (pathPolyline) {
              pathPolyline.addLatLng(point);
            } else {
              pathPolyline = L.polyline([point], {
                color: "#22c55e",
                weight: 5,
              }).addTo(map);
            }
          },
          (err) => {
            console.error(err);
            gpsStatusEl.textContent =
              "Erro no GPS. Verifique as permiss√µes do seu aparelho.";
          },
          {
            enableHighAccuracy: true,
            maximumAge: 0,
            timeout: 10000,
          }
        );
      }

      async function stopRecording() {
        recording = false;
        btnToggleRoute.textContent = "‚ñ∂Ô∏è Iniciar trajeto";
        btnAddNest.disabled = true;
        gpsStatusEl.textContent = "Trajeto encerrado.";

        if (watchId !== null) {
          navigator.geolocation.clearWatch(watchId);
          watchId = null;
        }

        if (!currentRoute || !currentRoute.path.length) {
          currentRouteInfoEl.textContent = "Trajeto inativo.";
          currentRoute = null;
          return;
        }

        currentRouteInfoEl.textContent = `Trajeto conclu√≠do: ${currentRoute.name}`;
        await saveRouteToSupabase(currentRoute);
        currentRoute = null;
      }

      async function addNestWithPhoto() {
        if (!recording || !currentRoute) return;

        // obt√©m posi√ß√£o atual
        navigator.geolocation.getCurrentPosition(
          async (pos) => {
            try {
              const { latitude, longitude } = pos.coords;

              // tira foto (via input file)
              const input = document.createElement("input");
              input.type = "file";
              input.accept = "image/*";
              input.capture = "environment";
              input.onchange = async () => {
                const file = input.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = async (e) => {
                  const dataUrl = e.target.result;

                  const trapId = Date.now().toString();
                  let photoUrl = null;

                  try {
                    // envia para Storage (rotas ainda n√£o t√™m ID no momento da grava√ß√£o)
                    photoUrl = await uploadNestPhoto("temp", trapId, dataUrl);
                  } catch (err) {
                    console.error("Erro ao salvar foto no Storage:", err);
                    alert(
                      "Erro ao enviar foto para a nuvem. Ela ficar√° apenas neste aparelho para este trajeto."
                    );
                    photoUrl = dataUrl;
                  }

                  currentRoute.traps.push({
                    id: trapId,
                    lat: latitude,
                    lng: longitude,
                    ts: Date.now(),
                    photoUrl,
                  });

                  alert("Ninho marcado com sucesso!");
                };
                reader.readAsDataURL(file);
              };
              input.click();
            } catch (err) {
              console.error(err);
              alert("N√£o foi poss√≠vel registrar o ninho.");
            }
          },
          (err) => {
            console.error(err);
            alert("Erro ao obter localiza√ß√£o atual.");
          },
          { enableHighAccuracy: true, timeout: 10000 }
        );
      }

      function focusRouteOnMap(route) {
        const path = route.path || [];
        if (!path.length || !map) return;

        if (pathPolyline) {
          map.removeLayer(pathPolyline);
        }

        const latlngs = path.map((p) => [p.lat, p.lng]);
        pathPolyline = L.polyline(latlngs, {
          color: "#22c55e",
          weight: 5,
        }).addTo(map);
        map.fitBounds(pathPolyline.getBounds(), { padding: [30, 30] });
      }

      // ========= UI lateral =========
      let sidebarHidden = false;
      btnToggleSidebar.addEventListener("click", () => {
        const leftPanel = document.querySelector(".left-panel");
        sidebarHidden = !sidebarHidden;
        leftPanel.style.display = sidebarHidden ? "none" : "flex";
        btnToggleSidebar.innerHTML = sidebarHidden
          ? '<span>üß≠</span> Mostrar painel'
          : '<span>üß≠</span> Focar no mapa';
      });

      // ========= Modal foto =========
      photoModalClose.addEventListener("click", () => {
        photoModal.classList.remove("open");
        photoModalImg.src = "";
      });
      photoModal.addEventListener("click", (e) => {
        if (e.target === photoModal) {
          photoModal.classList.remove("open");
          photoModalImg.src = "";
        }
      });

      // ========= Event listeners globais =========
      btnSignUp.addEventListener("click", handleSignUp);
      btnSignIn.addEventListener("click", handleSignIn);
      btnGoogle.addEventListener("click", handleSignInWithGoogle);
      btnLogout.addEventListener("click", handleLogout);

      btnToggleRoute.addEventListener("click", () => {
        if (!recording) startRecording();
        else stopRecording();
      });

      btnAddNest.addEventListener("click", addNestWithPhoto);

      // ========= Inicializa√ß√£o =========
      window.addEventListener("load", async () => {
        initMap();
        await refreshSessionAndData();
      });
    </script>
  </body>
</html>
