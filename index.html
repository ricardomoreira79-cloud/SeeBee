<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <title>BeeTrack ‚Äì Rastreador de ninhos de abelhas</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="theme-color" content="#050816" />

    <!-- PWA / instala√ß√£o -->
    <link rel="manifest" href="manifest.webmanifest" />

    <!-- Leaflet CSS -->
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
      crossorigin=""
    />

    <style>
      :root {
        --bg: #020617;
        --bg-elevated: #020617;
        --card: #020617;
        --card-strong: #020617;
        --accent: #22c55e;
        --accent-soft: rgba(34, 197, 94, 0.12);
        --accent-strong: #16a34a;
        --danger: #f97373;
        --danger-soft: rgba(248, 113, 113, 0.15);
        --text: #e5e7eb;
        --text-soft: #9ca3af;
        --border: rgba(148, 163, 184, 0.25);
        --input: #020617;
        --radius-xl: 18px;
        --radius-lg: 14px;
        --radius-pill: 999px;
        --shadow-soft: 0 22px 45px rgba(15, 23, 42, 0.8);
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
          "Segoe UI", sans-serif;
        background: radial-gradient(circle at top, #1f2937 0, #020617 52%);
        color: var(--text);
        min-height: 100vh;
        display: flex;
        justify-content: center;
        align-items: stretch;
      }

      .app-shell {
        width: 100%;
        max-width: 1120px;
        margin: 16px;
        background: radial-gradient(circle at top left, #0f172a 0, #020617 55%);
        border-radius: 24px;
        box-shadow: var(--shadow-soft);
        border: 1px solid rgba(148, 163, 184, 0.28);
        overflow: hidden;
        display: flex;
        flex-direction: column;
      }

      /* HEADER */

      .app-header {
        padding: 16px 20px 12px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        border-bottom: 1px solid rgba(148, 163, 184, 0.25);
        backdrop-filter: blur(16px);
        background: linear-gradient(
          135deg,
          rgba(15, 23, 42, 0.92),
          rgba(15, 23, 42, 0.98)
        );
      }

      .brand {
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .logo-circle {
        width: 42px;
        height: 42px;
        border-radius: 50%;
        background: radial-gradient(circle at 30% 30%, #facc15, #f97316);
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 0 0 2px rgba(15, 23, 42, 0.9),
          0 8px 18px rgba(0, 0, 0, 0.6);
        font-size: 22px;
      }

      .brand h1 {
        margin: 0;
        font-size: 18px;
        letter-spacing: 0.03em;
      }

      .brand p {
        margin: 0;
        font-size: 12px;
        color: var(--text-soft);
      }

      .status-pill {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 6px 11px;
        border-radius: 999px;
        background: rgba(15, 118, 110, 0.2);
        border: 1px solid rgba(45, 212, 191, 0.35);
        font-size: 11px;
        color: #a5f3fc;
        white-space: nowrap;
      }

      .status-dot {
        width: 7px;
        height: 7px;
        border-radius: 50%;
        background: #9ca3af;
        box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.4);
        transition: all 0.25s ease;
      }

      .status-dot.online {
        background: #22c55e;
        box-shadow: 0 0 0 6px rgba(34, 197, 94, 0.18);
      }

      .status-dot.offline {
        background: #f97373;
        box-shadow: 0 0 0 6px rgba(248, 113, 113, 0.18);
      }

      /* LAYOUT PRINCIPAL */

      .app-layout {
        display: grid;
        grid-template-columns: minmax(0, 360px) minmax(0, 1.2fr);
        gap: 12px;
        padding: 12px;
      }

      .left-panel {
        display: flex;
        flex-direction: column;
        gap: 12px;
      }

      .map-wrapper {
        background: radial-gradient(circle at top, #020617 0, #020617 60%);
        border-radius: 20px;
        border: 1px solid rgba(148, 163, 184, 0.3);
        padding: 10px 10px 12px;
        display: flex;
        flex-direction: column;
        gap: 10px;
      }

      .map-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 8px;
      }

      .map-header h2 {
        margin: 0;
        font-size: 15px;
      }

      .map-header p {
        margin: 0;
        font-size: 12px;
        color: var(--text-soft);
      }

      #map {
        width: 100%;
        height: 420px;
        border-radius: 15px;
        overflow: hidden;
        box-shadow: 0 14px 28px rgba(15, 23, 42, 0.9);
      }

      .leaflet-control-attribution {
        font-size: 9px !important;
      }

      /* CARDS */

      .card {
        background: radial-gradient(circle at top left, #020617 0, #020617 60%);
        border-radius: var(--radius-lg);
        border: 1px solid rgba(148, 163, 184, 0.3);
        padding: 11px 12px 12px;
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .card-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 8px;
      }

      .card-header h2 {
        margin: 0;
        font-size: 15px;
      }

      .card-header p {
        margin: 0;
        font-size: 12px;
        color: var(--text-soft);
      }

      .badge {
        font-size: 11px;
        border-radius: 999px;
        padding: 3px 10px;
        border: 1px solid rgba(148, 163, 184, 0.5);
        color: var(--text-soft);
      }

      .badge-ghost {
        background: rgba(15, 23, 42, 0.8);
      }

      /* FORM LOGIN */

      .field-group {
        display: flex;
        flex-direction: column;
        gap: 4px;
        margin-top: 4px;
      }

      label {
        font-size: 12px;
        color: var(--text-soft);
      }

      input[type="email"],
      input[type="password"],
      input[type="text"] {
        background: rgba(15, 23, 42, 0.8);
        border-radius: 999px;
        border: 1px solid rgba(148, 163, 184, 0.45);
        padding: 6px 12px;
        font-size: 13px;
        color: var(--text);
        outline: none;
      }

      input::placeholder {
        color: #6b7280;
      }

      input:focus {
        border-color: var(--accent);
        box-shadow: 0 0 0 1px rgba(34, 197, 94, 0.4);
      }

      .auth-actions {
        display: flex;
        gap: 8px;
        margin-top: 6px;
        flex-wrap: wrap;
      }

      .muted {
        font-size: 11px;
        color: var(--text-soft);
      }

      .muted strong {
        color: var(--accent);
        font-weight: 500;
      }

      /* BOT√ïES */

      button {
        font-family: inherit;
      }

      .btn {
        border: none;
        border-radius: var(--radius-pill);
        padding: 7px 14px;
        font-size: 13px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
        cursor: pointer;
        transition: transform 0.08s ease, box-shadow 0.08s ease,
          background 0.12s ease, border-color 0.12s ease;
        white-space: nowrap;
      }

      .btn-primary {
        background: linear-gradient(135deg, #22c55e, #16a34a);
        color: #0b1120;
        box-shadow: 0 8px 18px rgba(34, 197, 94, 0.35);
      }

      .btn-primary:active {
        transform: translateY(1px);
        box-shadow: 0 4px 10px rgba(34, 197, 94, 0.35);
      }

      .btn-ghost {
        background: rgba(15, 23, 42, 0.85);
        border: 1px solid rgba(148, 163, 184, 0.6);
        color: var(--text-soft);
      }

      .btn-ghost:active {
        transform: translateY(1px);
      }

      .btn-danger {
        background: var(--danger-soft);
        color: #fecaca;
        border: 1px solid rgba(248, 113, 113, 0.7);
      }

      .btn-sm {
        padding: 5px 10px;
        font-size: 12px;
      }

      .btn-icon {
        border-radius: 999px;
        width: 32px;
        height: 32px;
        padding: 0;
      }

      .btn[disabled] {
        opacity: 0.55;
        cursor: default;
        box-shadow: none;
      }

      /* CONTROLE DE TRAJETO */

      .pill-row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 6px;
      }

      .pill-label {
        font-size: 12px;
        color: var(--text-soft);
      }

      .pill-value {
        font-size: 12px;
        color: var(--accent);
      }

      .kpi-row {
        display: flex;
        justify-content: space-between;
        gap: 6px;
        font-size: 11px;
        color: var(--text-soft);
      }

      .kpi-row span strong {
        color: var(--text);
      }

      /* LISTA DE TRAJETOS */

      .routes-list {
        max-height: 180px;
        overflow: auto;
        padding-right: 2px;
        display: flex;
        flex-direction: column;
        gap: 6px;
      }

      .route-item {
        border-radius: 12px;
        padding: 7px 8px;
        background: rgba(15, 23, 42, 0.9);
        border: 1px solid rgba(148, 163, 184, 0.35);
        display: flex;
        flex-direction: column;
        gap: 4px;
        cursor: pointer;
      }

      .route-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 6px;
      }

      .route-header strong {
        font-size: 13px;
      }

      .route-meta {
        font-size: 11px;
        color: var(--text-soft);
      }

      .route-actions {
        display: flex;
        gap: 4px;
        margin-top: 4px;
      }

      /* LISTA DE NINHOS */

      .traps-list {
        max-height: 140px;
        overflow: auto;
        display: flex;
        flex-direction: column;
        gap: 6px;
      }

      .trap-item {
        border-radius: 10px;
        padding: 6px 7px;
        background: rgba(15, 23, 42, 0.95);
        border: 1px solid rgba(148, 163, 184, 0.3);
        font-size: 11px;
        display: flex;
        justify-content: space-between;
        gap: 6px;
      }

      .trap-text {
        display: flex;
        flex-direction: column;
        gap: 2px;
      }

      .trap-text span {
        font-size: 11px;
      }

      .trap-actions {
        display: flex;
        flex-direction: column;
        gap: 3px;
      }

      .tag {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        padding: 2px 7px;
        border-radius: 999px;
        font-size: 10px;
        border: 1px solid rgba(148, 163, 184, 0.5);
        color: var(--text-soft);
      }

      .tag-dot {
        width: 6px;
        height: 6px;
        border-radius: 999px;
      }

      .tag-dot-green {
        background: #22c55e;
      }

      .tag-dot-blue {
        background: #38bdf8;
      }

      /* ALERTAS / STATUS */

      .status-text {
        font-size: 11px;
        color: var(--text-soft);
      }

      .status-text strong {
        color: var(--accent);
      }

      .status-text.warn {
        color: #fbbf24;
      }

      .status-text.error {
        color: #fecaca;
      }

      /* RESPONSIVO */

      @media (max-width: 880px) {
        .app-shell {
          margin: 10px;
        }

        .app-layout {
          grid-template-columns: minmax(0, 1fr);
        }

        /* NO CELULAR: painel (login/controles) primeiro, mapa depois */
        .left-panel {
          order: 1;
        }

        .map-wrapper {
          order: 2;
          margin-top: 6px;
        }

        #map {
          height: 320px;
        }

        .app-header {
          flex-direction: column;
          align-items: flex-start;
          gap: 8px;
        }
      }
    </style>
  </head>
  <body>
    <div class="app-shell">
      <header class="app-header">
        <div class="brand">
          <div class="logo-circle">üêù</div>
          <div>
            <h1>BeeTrack</h1>
            <p>Rastreador de ninhos de abelhas</p>
          </div>
        </div>
        <div class="status-pill">
          <span id="supabase-status-dot" class="status-dot"></span>
          <span id="supabase-status-text">Conectando √† nuvem...</span>
        </div>
      </header>

      <main class="app-layout">
        <!-- PAINEL ESQUERDO -->
        <section class="left-panel">
          <!-- LOGIN -->
          <section class="card">
            <div class="card-header">
              <div>
                <h2>Acesso</h2>
                <p>Entre com e-mail ou Google para salvar na nuvem.</p>
              </div>
              <span class="badge badge-ghost" id="auth-status-badge">
                Visitante
              </span>
            </div>

            <div class="field-group">
              <label for="email-input">E-mail</label>
              <input
                type="email"
                id="email-input"
                placeholder="seuemail@exemplo.com"
                autocomplete="email"
              />
            </div>

            <div class="field-group">
              <label for="password-input">Senha</label>
              <input
                type="password"
                id="password-input"
                minlength="6"
                placeholder="M√≠nimo 6 caracteres"
                autocomplete="current-password"
              />
            </div>

            <div class="auth-actions">
              <button class="btn btn-ghost btn-sm" id="btn-sign-in">
                Entrar
              </button>
              <button class="btn btn-ghost btn-sm" id="btn-sign-up">
                Criar conta
              </button>
            </div>

            <button class="btn btn-ghost btn-sm" id="btn-sign-google">
              <span>üîê</span> Entrar com Google
            </button>

            <button
              class="btn btn-ghost btn-sm"
              id="btn-sign-out"
              style="display: none; margin-top: 4px"
            >
              Sair da conta
            </button>

            <p class="muted" id="auth-helper">
              Sem login, os trajetos ficam apenas neste aparelho.
            </p>
          </section>

          <!-- CONTROLE DE TRAJETO -->
          <section class="card">
            <div class="card-header">
              <div>
                <h2>Controle de trajeto</h2>
                <p>Grave o caminho e marque ninhos com foto.</p>
              </div>
              <span class="badge">Modo campo</span>
            </div>

            <div class="pill-row">
              <span class="pill-label">Status do trajeto</span>
              <span class="pill-value" id="route-status-label">
                Inativo
              </span>
            </div>

            <div class="kpi-row">
              <span
                >Pontos: <strong id="route-points-count">0</strong></span
              >
              <span
                >Ninhos: <strong id="route-traps-count">0</strong></span
              >
            </div>

            <div class="auth-actions" style="margin-top: 8px">
              <button
                class="btn btn-primary"
                id="btn-toggle-route"
              >
                ‚ñ∂ Iniciar trajeto
              </button>
              <button
                class="btn btn-ghost"
                id="btn-add-trap"
                disabled
              >
                üìç Marcar ninho com foto
              </button>
            </div>

            <p class="status-text" id="gps-status">
              üåê Aguardando GPS‚Ä¶
            </p>
            <p
              class="status-text warn"
              id="offline-warning"
              style="display: none"
            >
              Sem conex√£o com a nuvem: tudo ser√° salvo apenas neste aparelho.
            </p>
          </section>

          <!-- TRAJETOS SALVOS -->
          <section class="card">
            <div class="card-header">
              <div>
                <h2>Trajetos salvos</h2>
                <p>Toque para abrir, renomear ou apagar.</p>
              </div>
            </div>

            <div class="routes-list" id="routes-list"></div>
            <p class="muted" id="no-routes-msg">
              Nenhum trajeto salvo ainda.
            </p>
          </section>

          <!-- NINHOS DO TRAJETO ATUAL -->
          <section class="card">
            <div class="card-header">
              <div>
                <h2>Ninhos do trajeto</h2>
                <p>Lista de ninhos marcados neste trajeto.</p>
              </div>
            </div>

            <div class="traps-list" id="traps-list"></div>
            <p class="muted" id="no-traps-msg">
              Nenhum ninho marcado ainda.
            </p>

            <button
              class="btn btn-ghost btn-sm"
              id="btn-monitor-traps"
              disabled
            >
              ‚û°Ô∏è Monitorar ninhos na ordem
            </button>
          </section>
        </section>

        <!-- MAPA -->
        <section class="map-wrapper">
          <div class="map-header">
            <div>
              <h2>Mapa de campo</h2>
              <p>Arraste, d√™ zoom e acompanhe o caminho em tempo real.</p>
            </div>
            <button class="btn btn-ghost btn-sm" id="btn-focus-map">
              üß≠ Focar no mapa
            </button>
          </div>
          <div id="map"></div>
        </section>
      </main>
    </div>

    <!-- input escondido para fotos -->
    <input
      type="file"
      id="photo-input"
      accept="image/*"
      capture="environment"
      style="display: none"
    />

    <!-- Leaflet JS -->
    <script
      src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
      integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
      crossorigin=""
    ></script>

    <!-- Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>

    <script>
      // ==== CONFIGURA√á√ÉO SUPABASE ====
      const SUPABASE_URL = "https://sgrtyotwnlwpwfecnoze.supabase.co"; // TODO: troque aqui
      const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNncnR5b3R3bmx3cHdmZWNub3plIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc3NjgxMjcsImV4cCI6MjA4MzM0NDEyN30.QZvTN3mHUwqBwvXeL6q89qNW_4s1Cvopa40nt4TFa9w"; // TODO: troque aqui

      const supabase = window.supabase.createClient(
        SUPABASE_URL,
        SUPABASE_ANON_KEY
      );

      // elementos b√°sicos
      const statusDot = document.getElementById("supabase-status-dot");
      const statusText = document.getElementById("supabase-status-text");
      const authStatusBadge = document.getElementById("auth-status-badge");
      const authHelper = document.getElementById("auth-helper");
      const offlineWarning = document.getElementById("offline-warning");

      const emailInput = document.getElementById("email-input");
      const passwordInput = document.getElementById("password-input");

      const btnSignIn = document.getElementById("btn-sign-in");
      const btnSignUp = document.getElementById("btn-sign-up");
      const btnSignGoogle = document.getElementById("btn-sign-google");
      const btnSignOut = document.getElementById("btn-sign-out");

      const btnToggleRoute = document.getElementById("btn-toggle-route");
      const btnAddTrap = document.getElementById("btn-add-trap");
      const btnFocusMap = document.getElementById("btn-focus-map");
      const btnMonitorTraps = document.getElementById("btn-monitor-traps");

      const gpsStatus = document.getElementById("gps-status");
      const routeStatusLabel = document.getElementById("route-status-label");
      const routePointsCount = document.getElementById("route-points-count");
      const routeTrapsCount = document.getElementById("route-traps-count");

      const routesListEl = document.getElementById("routes-list");
      const noRoutesMsg = document.getElementById("no-routes-msg");
      const trapsListEl = document.getElementById("traps-list");
      const noTrapsMsg = document.getElementById("no-traps-msg");

      const photoInput = document.getElementById("photo-input");

      let supabaseOnline = false;
      let currentUser = null;

      // estado de trajeto
      let watchId = null;
      let map, userMarker, pathPolyline;
      let currentRoute = null; // {id?, name, createdAt, path[], traps[]}
      let savedRoutes = [];
      let trapMarkers = {};
      let monitorIndex = 0;

      const LOCAL_KEY = "beetrack_routes_v1";

      // ========= MAPA =========
      function initMap() {
        map = L.map("map");
        const tiles = L.tileLayer(
          "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",
          {
            maxZoom: 19,
            attribution: "&copy; OpenStreetMap contributors",
          }
        );
        tiles.addTo(map);
        map.setView([-15.6, -56.1], 4); // Brasil

        pathPolyline = L.polyline([], { color: "#22c55e", weight: 4 }).addTo(
          map
        );

        // tentar pegar posi√ß√£o logo no in√≠cio
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(
            (pos) => {
              const { latitude, longitude } = pos.coords;
              map.setView([latitude, longitude], 16);
              updateUserMarker(latitude, longitude);
            },
            () => {},
            { enableHighAccuracy: true, timeout: 10000 }
          );
        } else {
          gpsStatus.textContent =
            "GPS n√£o dispon√≠vel neste dispositivo/navegador.";
        }
      }

      function updateUserMarker(lat, lng) {
        if (!userMarker) {
          userMarker = L.marker([lat, lng]).addTo(map);
        } else {
          userMarker.setLatLng([lat, lng]);
        }
      }

      function updatePathOnMap() {
        if (!currentRoute) return;
        pathPolyline.setLatLngs(currentRoute.path);
        if (currentRoute.path.length > 0) {
          map.fitBounds(pathPolyline.getBounds(), { maxZoom: 18 });
        }
        routePointsCount.textContent = currentRoute.path.length;
      }

      function clearTrapMarkers() {
        Object.values(trapMarkers).forEach((m) => map.removeLayer(m));
        trapMarkers = {};
      }

      function renderTraps(route) {
        trapsListEl.innerHTML = "";
        clearTrapMarkers();

        if (!route || !route.traps || route.traps.length === 0) {
          noTrapsMsg.style.display = "block";
          btnMonitorTraps.disabled = true;
          routeTrapsCount.textContent = "0";
          return;
        }

        noTrapsMsg.style.display = "none";
        btnMonitorTraps.disabled = false;
        routeTrapsCount.textContent = route.traps.length;

        route.traps.forEach((trap, idx) => {
          // marker no mapa
          const marker = L.marker([trap.lat, trap.lng]).addTo(map);
          marker.bindPopup(
            `<strong>Ninho ${idx + 1}</strong><br>${new Date(
              trap.createdAt
            ).toLocaleString()}`
          );
          trapMarkers[trap.localId] = marker;

          // item na lista
          const li = document.createElement("div");
          li.className = "trap-item";

          const text = document.createElement("div");
          text.className = "trap-text";
          const title = document.createElement("span");
          title.innerHTML = `<strong>Ninho ${idx + 1}</strong>`;
          const meta = document.createElement("span");
          meta.textContent = new Date(trap.createdAt).toLocaleString();
          text.appendChild(title);
          text.appendChild(meta);

          const actions = document.createElement("div");
          actions.className = "trap-actions";

          const btnVer = document.createElement("button");
          btnVer.className = "btn btn-ghost btn-sm";
          btnVer.textContent = "Ver no mapa";
          btnVer.addEventListener("click", () => {
            map.setView([trap.lat, trap.lng], 19);
            marker.openPopup();
          });

          const btnFoto = document.createElement("button");
          btnFoto.className = "btn btn-ghost btn-sm";
          btnFoto.textContent = "Ver foto";
          btnFoto.disabled = !trap.photoUrl;
          btnFoto.addEventListener("click", () => {
            if (trap.photoUrl) {
              window.open(trap.photoUrl, "_blank");
            }
          });

          actions.appendChild(btnVer);
          actions.appendChild(btnFoto);

          li.appendChild(text);
          li.appendChild(actions);

          trapsListEl.appendChild(li);
        });
      }

      // ========= LOCAL STORAGE =========
      function loadRoutesFromLocal() {
        try {
          const raw = localStorage.getItem(LOCAL_KEY);
          if (!raw) return;
          const parsed = JSON.parse(raw);
          if (Array.isArray(parsed)) {
            savedRoutes = parsed;
          }
        } catch (e) {
          console.error("Erro lendo localStorage", e);
        }
      }

      function saveRoutesToLocal() {
        try {
          localStorage.setItem(LOCAL_KEY, JSON.stringify(savedRoutes));
        } catch (e) {
          console.error("Erro salvando localStorage", e);
        }
      }

      // ========= SUPABASE HELPERS =========
      async function checkSupabaseConnection() {
        try {
          const { error } = await supabase.from("routes").select("id").limit(1);
          if (error) throw error;
          supabaseOnline = true;
        } catch (e) {
          supabaseOnline = false;
        }
        updateConnectionUI();
      }

      function updateConnectionUI() {
        if (supabaseOnline) {
          statusDot.classList.add("online");
          statusDot.classList.remove("offline");
          statusText.textContent = "Conectado √† nuvem (Supabase)";
          offlineWarning.style.display = currentUser ? "none" : "block";
        } else {
          statusDot.classList.add("offline");
          statusDot.classList.remove("online");
          statusText.textContent = "Offline em rela√ß√£o √† nuvem";
          offlineWarning.style.display = "block";
        }
      }

      async function loadRoutesFromSupabase() {
        if (!currentUser || !supabaseOnline) return;
        const { data, error } = await supabase
          .from("routes")
          .select("*")
          .order("created_at", { ascending: false });
        if (error) {
          console.error(error);
          return;
        }
        savedRoutes = data.map((row) => ({
          id: row.id,
          name: row.name || "Trajeto sem nome",
          createdAt: row.created_at,
          path: row.path || [],
          traps: row.traps || [],
        }));
        saveRoutesToLocal();
        renderRoutesList();
      }

      async function persistRouteToSupabase(route) {
        if (!currentUser || !supabaseOnline) return;

        if (!route.id) {
          const { data, error } = await supabase
            .from("routes")
            .insert({
              name: route.name,
              path: route.path,
              traps: route.traps,
            })
            .select()
            .single();
          if (error) throw error;
          route.id = data.id;
        } else {
          const { error } = await supabase
            .from("routes")
            .update({
              name: route.name,
              path: route.path,
              traps: route.traps,
            })
            .eq("id", route.id);
          if (error) throw error;
        }
      }

      async function deleteRouteFromSupabase(route) {
        if (!currentUser || !supabaseOnline || !route.id) return;
        await supabase.from("routes").delete().eq("id", route.id);
      }

      async function uploadTrapPhoto(file, routeId, localTrapId) {
        if (!currentUser || !supabaseOnline) return null;
        const ext = file.name.split(".").pop() || "jpg";
        const filePath = `${currentUser.id}/${routeId || "sem-id"}/${Date.now()}_${
          localTrapId || "trap"
        }.${ext}`;

        const { data, error } = await supabase.storage
          .from("ninhos-fotos")
          .upload(filePath, file, {
            cacheControl: "3600",
            upsert: false,
          });
        if (error) throw error;

        const { data: urlData } = supabase.storage
          .from("ninhos-fotos")
          .getPublicUrl(data.path);

        return { path: data.path, url: urlData.publicUrl };
      }

      // ========= AUTH =========
      function updateAuthUI() {
        if (currentUser) {
          authStatusBadge.textContent = "Logado";
          authStatusBadge.style.color = "#bbf7d0";
          authStatusBadge.style.borderColor = "rgba(34,197,94,0.7)";
          authHelper.innerHTML =
            "Seus trajetos de campo s√£o salvos na nuvem para acessar em qualquer aparelho.";
          btnSignOut.style.display = "inline-flex";
          btnSignIn.style.display = "none";
          btnSignUp.style.display = "none";
          btnSignGoogle.style.display = "none";
        } else {
          authStatusBadge.textContent = "Visitante";
          authStatusBadge.style.color = "var(--text-soft)";
          authStatusBadge.style.borderColor = "rgba(148,163,184,0.5)";
          authHelper.innerHTML =
            "Sem login, os trajetos ficam apenas neste aparelho.";
          btnSignOut.style.display = "none";
          btnSignIn.style.display = "inline-flex";
          btnSignUp.style.display = "inline-flex";
          btnSignGoogle.style.display = "inline-flex";
        }
      }

      async function initAuth() {
        const {
          data: { session },
        } = await supabase.auth.getSession();
        currentUser = session ? session.user : null;
        updateAuthUI();
        if (currentUser) {
          await loadRoutesFromSupabase();
        } else {
          loadRoutesFromLocal();
          renderRoutesList();
        }

        supabase.auth.onAuthStateChange(async (event, session) => {
          currentUser = session ? session.user : null;
          updateAuthUI();
          await checkSupabaseConnection();
          if (currentUser) {
            await loadRoutesFromSupabase();
          } else {
            loadRoutesFromLocal();
            renderRoutesList();
          }
        });
      }

      async function signInEmail() {
        const email = emailInput.value.trim();
        const password = passwordInput.value.trim();
        if (!email || !password) {
          alert("Informe e-mail e senha.");
          return;
        }
        const { error } = await supabase.auth.signInWithPassword({
          email,
          password,
        });
        if (error) alert(error.message);
      }

      async function signUpEmail() {
        const email = emailInput.value.trim();
        const password = passwordInput.value.trim();
        if (!email || !password) {
          alert("Informe e-mail e senha.");
          return;
        }
        const { error } = await supabase.auth.signUp({
          email,
          password,
        });
        if (error) alert(error.message);
        else alert("Conta criada. Verifique seu e-mail, se solicitado.");
      }

      async function signInGoogle() {
        const { error } = await supabase.auth.signInWithOAuth({
          provider: "google",
          options: {
            redirectTo: window.location.href,
          },
        });
        if (error) alert(error.message);
      }

      async function signOut() {
        await supabase.auth.signOut();
      }

      // ========= TRAJETOS =========
      function renderRoutesList() {
        routesListEl.innerHTML = "";
        if (!savedRoutes.length) {
          noRoutesMsg.style.display = "block";
          return;
        }
        noRoutesMsg.style.display = "none";

        savedRoutes.forEach((route, index) => {
          const item = document.createElement("div");
          item.className = "route-item";

          const header = document.createElement("div");
          header.className = "route-header";

          const title = document.createElement("strong");
          title.textContent =
            route.name || `Trajeto ${savedRoutes.length - index}`;

          const tag = document.createElement("span");
          tag.className = "tag";
          const dot = document.createElement("span");
          dot.className = "tag-dot tag-dot-green";
          const txt = document.createElement("span");
          txt.textContent = `${(route.traps || []).length} ninhos`;
          tag.appendChild(dot);
          tag.appendChild(txt);

          header.appendChild(title);
          header.appendChild(tag);

          const meta = document.createElement("div");
          meta.className = "route-meta";
          meta.textContent = new Date(route.createdAt).toLocaleString();

          const actions = document.createElement("div");
          actions.className = "route-actions";

          const btnAbrir = document.createElement("button");
          btnAbrir.className = "btn btn-ghost btn-sm";
          btnAbrir.textContent = "Abrir";
          btnAbrir.addEventListener("click", () => {
            openRoute(route);
          });

          const btnRenomear = document.createElement("button");
          btnRenomear.className = "btn btn-ghost btn-sm";
          btnRenomear.textContent = "Renomear";
          btnRenomear.addEventListener("click", async () => {
            const novo = prompt("Novo nome para o trajeto:", route.name || "");
            if (!novo) return;
            route.name = novo;
            renderRoutesList();
            saveRoutesToLocal();
            try {
              await persistRouteToSupabase(route);
            } catch (e) {
              console.error(e);
            }
          });

          const btnExcluir = document.createElement("button");
          btnExcluir.className = "btn btn-danger btn-sm";
          btnExcluir.textContent = "Excluir";
          btnExcluir.addEventListener("click", async () => {
            if (!confirm("Excluir este trajeto?")) return;
            const idx = savedRoutes.indexOf(route);
            if (idx >= 0) savedRoutes.splice(idx, 1);
            saveRoutesToLocal();
            renderRoutesList();
            if (currentRoute === route) {
              currentRoute = null;
              pathPolyline.setLatLngs([]);
              clearTrapMarkers();
              renderTraps(null);
            }
            try {
              await deleteRouteFromSupabase(route);
            } catch (e) {
              console.error(e);
            }
          });

          actions.appendChild(btnAbrir);
          actions.appendChild(btnRenomear);
          actions.appendChild(btnExcluir);

          item.appendChild(header);
          item.appendChild(meta);
          item.appendChild(actions);

          routesListEl.appendChild(item);
        });
      }

      function openRoute(route) {
        currentRoute = {
          ...route,
          path: route.path || [],
          traps: route.traps || [],
        };
        updatePathOnMap();
        renderTraps(currentRoute);
        routeStatusLabel.textContent = "Trajeto carregado";
        btnAddTrap.disabled = true;
        btnToggleRoute.textContent = "‚ñ∂ Iniciar novo trajeto";
      }

      function startRoute() {
        currentRoute = {
          id: null,
          name:
            prompt("Nome do trajeto (opcional):", "Trajeto de campo") ||
            "Trajeto de campo",
          createdAt: new Date().toISOString(),
          path: [],
          traps: [],
        };
        monitorIndex = 0;
        pathPolyline.setLatLngs([]);
        clearTrapMarkers();
        renderTraps(currentRoute);
        routeStatusLabel.textContent = "Gravando‚Ä¶";
        btnAddTrap.disabled = false;
        btnToggleRoute.textContent = "‚èπ Finalizar trajeto";

        if (navigator.geolocation) {
          watchId = navigator.geolocation.watchPosition(
            (pos) => {
              const { latitude, longitude } = pos.coords;
              gpsStatus.textContent = `üìç ${latitude.toFixed(
                5
              )}, ${longitude.toFixed(5)}`;
              updateUserMarker(latitude, longitude);

              if (currentRoute) {
                const last =
                  currentRoute.path[currentRoute.path.length - 1] || null;
                if (
                  !last ||
                  L.latLng(last[0], last[1]).distanceTo(
                    L.latLng(latitude, longitude)
                  ) > 4
                ) {
                  currentRoute.path.push([latitude, longitude]);
                  updatePathOnMap();
                }
              }
            },
            (err) => {
              console.error(err);
              gpsStatus.textContent =
                "Erro ao ler GPS. Verifique permiss√µes do navegador.";
            },
            { enableHighAccuracy: true, maximumAge: 5000, timeout: 20000 }
          );
        } else {
          gpsStatus.textContent = "GPS n√£o dispon√≠vel neste dispositivo.";
        }
      }

      async function finishRoute() {
        if (!currentRoute) return;
        routeStatusLabel.textContent = "Encerrando trajeto‚Ä¶";
        btnToggleRoute.disabled = true;
        btnAddTrap.disabled = true;

        // guarda na lista local
        savedRoutes.unshift(currentRoute);
        renderRoutesList();
        saveRoutesToLocal();

        let erroNuvem = false;
        if (supabaseOnline && currentUser) {
          try {
            await persistRouteToSupabase(currentRoute);
          } catch (e) {
            console.error(e);
            erroNuvem = true;
          }
        } else {
          erroNuvem = true;
        }

        routeStatusLabel.textContent = "Trajeto salvo";
        btnToggleRoute.disabled = false;
        btnToggleRoute.textContent = "‚ñ∂ Iniciar trajeto";

        if (erroNuvem) {
          alert(
            "Erro ao salvar trajeto na nuvem. Ele ficar√° apenas neste aparelho."
          );
        }

        if (navigator.geolocation && watchId != null) {
          navigator.geolocation.clearWatch(watchId);
          watchId = null;
        }

        currentRoute = null;
      }

      // ========= NINHOS =========
      function markTrap() {
        if (!currentRoute) {
          alert("Inicie um trajeto primeiro.");
          return;
        }
        if (!navigator.geolocation) {
          alert("GPS n√£o dispon√≠vel para marcar ninho.");
          return;
        }
        // pedimos a posi√ß√£o atual apenas para garantir que estamos atualizados
        navigator.geolocation.getCurrentPosition(
          (pos) => {
            const { latitude, longitude } = pos.coords;
            const localId = `${Date.now()}_${Math.random()
              .toString(36)
              .slice(2)}`;
            const trap = {
              localId,
              lat: latitude,
              lng: longitude,
              createdAt: new Date().toISOString(),
              photoUrl: null,
              storagePath: null,
            };
            currentRoute.traps.push(trap);
            renderTraps(currentRoute);
            saveRoutesToLocal();

            // abrir captura de foto
            photoInput.value = "";
            photoInput.onchange = async () => {
              const file = photoInput.files[0];
              if (!file) return;
              if (!currentUser || !supabaseOnline) {
                alert(
                  "Foto registrada apenas localmente (sem upload). Fa√ßa login e tenha conex√£o para enviar √† nuvem."
                );
                return;
              }
              try {
                const upload = await uploadTrapPhoto(
                  file,
                  currentRoute.id,
                  localId
                );
                trap.photoUrl = upload.url;
                trap.storagePath = upload.path;
                renderTraps(currentRoute);
                saveRoutesToLocal();
                await persistRouteToSupabase(currentRoute);
              } catch (e) {
                console.error(e);
                alert("Falha ao enviar foto para a nuvem.");
              }
            };
            photoInput.click();
          },
          (err) => {
            console.error(err);
            alert(
              "N√£o foi poss√≠vel obter a localiza√ß√£o atual para o ninho. Tente novamente."
            );
          },
          { enableHighAccuracy: true, timeout: 20000 }
        );
      }

      function monitorNextTrap() {
        if (!currentRoute || !currentRoute.traps.length) return;
        if (monitorIndex >= currentRoute.traps.length) monitorIndex = 0;
        const trap = currentRoute.traps[monitorIndex];
        monitorIndex++;

        map.setView([trap.lat, trap.lng], 19);
        const marker = trapMarkers[trap.localId];
        if (marker) marker.openPopup();
      }

      // ========= EVENTOS =========
      btnToggleRoute.addEventListener("click", () => {
        if (!currentRoute) {
          startRoute();
        } else if (routeStatusLabel.textContent.startsWith("Gravando")) {
          finishRoute();
        } else {
          // se um trajeto apenas carregado estiver ativo, iniciar novo
          startRoute();
        }
      });

      btnAddTrap.addEventListener("click", markTrap);
      btnFocusMap.addEventListener("click", () => {
        if (userMarker) {
          map.setView(userMarker.getLatLng(), 18);
        } else if (currentRoute && currentRoute.path.length) {
          map.fitBounds(pathPolyline.getBounds(), { maxZoom: 18 });
        }
      });

      btnMonitorTraps.addEventListener("click", monitorNextTrap);

      btnSignIn.addEventListener("click", signInEmail);
      btnSignUp.addEventListener("click", signUpEmail);
      btnSignGoogle.addEventListener("click", signInGoogle);
      btnSignOut.addEventListener("click", signOut);

      // ========= INICIALIZA√á√ÉO =========
      (async function init() {
        initMap();
        loadRoutesFromLocal();
        renderRoutesList();
        await checkSupabaseConnection();
        await initAuth();
      })();
    </script>
  </body>
</html>
