<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>SeeBee ‚Äì Rastreador de ninhos</title>

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#14532d" />

  <!-- PWA -->
  <link rel="manifest" href="manifest.webmanifest" />

  <!-- Leaflet -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <!-- Supabase -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

  <style>
    :root {
      --green-dark: #14532d;
      --green: #16a34a;
      --green-soft: #bbf7d0;
      --bg: #020617;
      --card-bg: #020617;
      --border: #1f2937;
      --text-main: #e5e7eb;
      --text-soft: #9ca3af;
      --danger: #b91c1c;
      --radius-lg: 14px;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #022c22 0, #020617 45%, #000 100%);
      color: var(--text-main);
    }

    button { font-family: inherit; }
    .hidden { display: none !important; }
    a { color: inherit; text-decoration: none; }

    /* ========= LAYOUT GERAL ========= */
    #auth-screen, #app-screen {
      max-width: 1200px;
      margin: 0 auto;
      padding: 16px;
    }

    /* ========= LOGIN (mais limpo) ========= */
    .auth-header { margin-top: 28px; margin-bottom: 6px; }

    .brand-hero {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
    }

    .brand-logo {
      width: 96px;
      height: 96px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 46px;
      background: radial-gradient(circle at 30% 20%, #facc15 0, #ea580c 45%, #7c2d12 100%);
      box-shadow: 0 18px 40px rgba(0, 0, 0, 0.8);
    }

    .brand-name {
      font-size: 2.1rem;
      font-weight: 750;
      letter-spacing: 0.08em;
      text-transform: none;
    }

    #auth-card {
      margin-top: 18px;
      max-width: 420px;
      margin-left: auto;
      margin-right: auto;
      padding: 22px 20px 18px;
      border-radius: var(--radius-lg);
      background: radial-gradient(circle at top left, #04785744, #020617 45%, #000 100%);
      border: 1px solid #1f2937;
      box-shadow: 0 18px 45px rgba(0, 0, 0, 0.75);
    }

    #auth-card h2 { margin: 0 0 8px; font-size: 1.15rem; }

    /* (removemos o par√°grafo grande do login por pedido seu) */
    #auth-card p { display: none; }

    .auth-field { margin-bottom: 14px; }
    .auth-field label {
      display: block;
      font-size: 0.8rem;
      margin-bottom: 4px;
      color: var(--text-soft);
    }
    .auth-field input {
      width: 100%;
      padding: 10px 10px;
      border-radius: 10px;
      border: 1px solid #374151;
      background: #020617;
      color: var(--text-main);
      font-size: 0.95rem;
      outline: none;
    }
    .auth-field input:focus {
      border-color: #22c55e;
      box-shadow: 0 0 0 3px rgba(34,197,94,0.18);
    }

    .auth-buttons { display: flex; gap: 8px; margin-top: 4px; }

    .btn-primary {
      flex: 1;
      background: linear-gradient(135deg, var(--green), #22c55e);
      border: none;
      padding: 10px 12px;
      border-radius: 999px;
      color: #022c22;
      font-weight: 700;
      cursor: pointer;
      font-size: 0.95rem;
      box-shadow: 0 10px 30px rgba(34, 197, 94, 0.35);
    }

    .btn-outline {
      flex: 1;
      background: transparent;
      border-radius: 999px;
      border: 1px solid #4b5563;
      color: var(--text-main);
      cursor: pointer;
      font-size: 0.95rem;
      padding: 10px 12px;
    }

    .btn-google {
      margin-top: 10px;
      width: 100%;
      border-radius: 999px;
      border: 1px solid #1f2937;
      background: #020617;
      color: var(--text-main);
      padding: 10px 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      cursor: pointer;
      font-size: 0.95rem;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.7);
    }

    .btn-google-icon {
      width: 18px;
      height: 18px;
      border-radius: 4px;
      background: conic-gradient(
        from 45deg,
        #4285f4 0 25%,
        #34a853 25% 50%,
        #fbbc05 50% 75%,
        #ea4335 75% 100%
      );
    }

    .auth-msg {
      margin-top: 12px;
      font-size: 0.85rem;
      min-height: 18px;
    }
    .auth-msg.error { color: #fecaca; }
    .auth-msg.ok { color: #bbf7d0; }

    /* ========= APP HEADER (mais limpo) ========= */
    header.app-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 12px;
      padding: 10px 10px;
      border-radius: 16px;
      border: 1px solid #1f2937;
      background: rgba(2,6,23,0.55);
      backdrop-filter: blur(10px);
      box-shadow: 0 14px 40px rgba(0,0,0,0.55);
    }

    .header-left {
      display: flex;
      flex-direction: column;
      gap: 6px;
      min-width: 0;
    }

    .header-left h1 {
      margin: 0;
      font-size: 1.05rem;
      letter-spacing: 0.02em;
    }

    /* removemos o texto grande de descri√ß√£o (pedido seu) */
    .header-left p { display: none; }

    .status-pill {
      font-size: 0.82rem;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid #15803d55;
      background: #064e3b;
      color: #bbf7d0;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      width: fit-content;
    }

    .status-pill.offline {
      border-color: #b91c1c88;
      background: #450a0a;
      color: #fecaca;
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: #22c55e;
      box-shadow: 0 0 0 4px rgba(34, 197, 94, 0.25);
    }

    .status-pill.offline .status-dot {
      background: #f97316;
      box-shadow: 0 0 0 4px rgba(248, 113, 113, 0.22);
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-shrink: 0;
    }

    .brand-mini {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      color: var(--text-soft);
      line-height: 1;
    }

    .brand-mini-logo {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 22px;
      background: radial-gradient(circle at 30% 20%, #facc15 0, #ea580c 45%, #7c2d12 100%);
      box-shadow: 0 10px 24px rgba(0, 0, 0, 0.7);
    }

    .brand-mini span {
      font-size: 0.78rem;
      letter-spacing: 0.03em;
      opacity: 0.9;
    }

    .user-info {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 6px;
      font-size: 0.8rem;
    }

    .user-email { color: var(--text-soft); max-width: 220px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

    .btn-ghost {
      border-radius: 999px;
      border: 1px solid #4b5563;
      background: transparent;
      color: var(--text-soft);
      padding: 6px 12px;
      font-size: 0.85rem;
      cursor: pointer;
    }
    .btn-ghost:hover { border-color: #9ca3af; color: #e5e7eb; }

    /* ========= APP ========= */
    .app-grid {
      display: grid;
      grid-template-columns: minmax(260px, 320px) minmax(0, 1fr);
      gap: 12px;
      align-items: stretch;
    }

    .card {
      background: radial-gradient(circle at top left, #065f4633, #020617 60%, #000 100%);
      border-radius: var(--radius-lg);
      border: 1px solid var(--border);
      padding: 14px 14px 12px;
      box-shadow: 0 16px 40px rgba(0, 0, 0, 0.8);
    }

    .card h3 {
      margin: 0 0 8px;
      font-size: 1rem;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .card-subtitle {
      margin: 0 0 12px;
      font-size: 0.8rem;
      color: var(--text-soft);
    }

    .badge {
      font-size: 0.7rem;
      padding: 2px 8px;
      border-radius: 999px;
      background: #022c22;
      color: #bbf7d0;
      border: 1px solid #14532d;
    }

    .controls-grid {
      display: grid;
      grid-template-columns: 1.6fr 1.4fr;
      gap: 8px;
      margin-bottom: 10px;
    }

    .btn-lg {
      width: 100%;
      border-radius: 999px;
      padding: 10px 12px;
      border: none;
      font-size: 0.95rem;
      font-weight: 700;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }

    .btn-start {
      background: linear-gradient(135deg, #16a34a, #22c55e);
      color: #022c22;
      box-shadow: 0 0 0 1px #15803d, 0 10px 25px rgba(16, 185, 129, 0.55);
    }

    .btn-stop {
      background: linear-gradient(135deg, #b91c1c, #f97316);
      color: #fff7ed;
      box-shadow: 0 0 0 1px #b91c1c, 0 10px 25px rgba(248, 113, 113, 0.6);
    }

    .btn-secondary {
      background: #020617;
      color: var(--text-main);
      border: 1px solid #4b5563;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.75);
    }

    .info-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      font-size: 0.82rem;
      color: var(--text-soft);
      padding-top: 6px;
      border-top: 1px dashed #1f2937;
      margin-top: 10px;
    }

    .info-pill {
      padding: 4px 10px;
      border-radius: 999px;
      background: #020617;
      border: 1px solid #1f2937;
    }

    /* MAPA (garantir que n√£o cubra conte√∫do) */
    #map {
      width: 100%;
      min-height: 320px;
      height: 360px;
      border-radius: var(--radius-lg);
      overflow: hidden;
    }

    .leaflet-container { background: #020617; }
    /* d√° um ‚Äúrespiro‚Äù para o attribution n√£o encostar em texto visual */
    .leaflet-control-attribution { font-size: 11px; opacity: 0.85; }

    /* LISTA DE TRAJETOS (agora num painel, para n√£o ‚Äúembaralhar‚Äù a tela) */
    .routes-open-row {
      margin-top: 12px;
      display: flex;
      justify-content: flex-end;
      gap: 8px;
    }

    .btn-small {
      border-radius: 999px;
      border: 1px solid #4b5563;
      background: #020617;
      color: var(--text-main);
      padding: 8px 12px;
      font-size: 0.9rem;
      cursor: pointer;
      box-shadow: 0 8px 22px rgba(0,0,0,0.6);
    }

    .btn-small:hover { border-color: #9ca3af; }

    /* DRAWER / PAINEL DE TRILHAS */
    #routes-drawer {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.78);
      display: none;
      align-items: flex-end;
      justify-content: center;
      z-index: 9998;
      padding: 14px;
    }

    .drawer-card {
      width: 100%;
      max-width: 620px;
      max-height: 82vh;
      overflow: auto;
      background: #020617;
      border: 1px solid #1f2937;
      border-radius: 18px;
      box-shadow: 0 24px 70px rgba(0,0,0,0.9);
      padding: 14px;
    }

    .drawer-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      margin-bottom: 10px;
    }

    .drawer-header h3 { margin: 0; font-size: 1rem; }
    .drawer-header .muted { color: var(--text-soft); font-size: 0.85rem; }

    .route-empty {
      font-size: 0.9rem;
      color: var(--text-soft);
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px dashed #1f2937;
      background: #02061766;
    }

    .route-card {
      margin-top: 8px;
      border-radius: 12px;
      border: 1px solid #1f2937;
      background: #020617d9;
      padding: 10px 12px;
      font-size: 0.9rem;
      display: grid;
      grid-template-columns: 1.6fr 1fr;
      gap: 10px;
      align-items: flex-start;
    }

    .route-main strong { display: block; margin-bottom: 4px; }
    .route-meta { color: var(--text-soft); font-size: 0.82rem; line-height: 1.25; }

    .route-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      justify-content: flex-end;
    }

    .btn-xs {
      border-radius: 999px;
      border: 1px solid #4b5563;
      background: #020617;
      color: var(--text-main);
      padding: 6px 10px;
      font-size: 0.85rem;
      cursor: pointer;
    }

    .btn-xs.danger { border-color: #7f1d1d; color: #fecaca; }

    .thumb {
      width: 42px;
      height: 42px;
      object-fit: cover;
      border-radius: 8px;
      border: 1px solid #1f2937;
      cursor: pointer;
    }

    .thumbs-row {
      display: flex;
      gap: 6px;
      margin-top: 6px;
      flex-wrap: wrap;
    }

    /* MODAL FOTO */
    #photo-modal {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.85);
      z-index: 9999;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 16px;
    }

    #photo-modal img {
      max-width: 100%;
      max-height: 100%;
      border-radius: 12px;
      box-shadow: 0 20px 50px rgba(0, 0, 0, 0.9);
    }

    #photo-modal-close {
      position: fixed;
      top: 16px;
      right: 16px;
      border-radius: 999px;
      border: none;
      background: #020617;
      color: #e5e7eb;
      padding: 8px 12px;
      cursor: pointer;
      font-size: 0.9rem;
      border: 1px solid #4b5563;
    }

    /* MODAL NINHO */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.82);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9000;
      padding: 16px;
    }

    .modal-card {
      width: 100%;
      max-width: 420px;
      background: #020617;
      border-radius: 18px;
      border: 1px solid #1f2937;
      box-shadow: 0 22px 50px rgba(0, 0, 0, 0.9);
      padding: 16px 18px 14px;
      color: var(--text-main);
    }

    .modal-card h4 { margin: 0 0 6px; font-size: 1rem; }
    .modal-card p {
      margin: 0 0 12px;
      font-size: 0.9rem;
      color: var(--text-soft);
    }

    .modal-field { margin-bottom: 10px; }
    .modal-field label {
      display: block;
      margin-bottom: 6px;
      font-size: 0.85rem;
      color: var(--text-soft);
    }

    .modal-field textarea {
      width: 100%;
      min-height: 90px;
      border-radius: 12px;
      border: 1px solid #334155;
      background: #0b1220;
      color: var(--text-main);
      padding: 10px 12px;
      font-size: 0.95rem;
      resize: vertical;
      outline: none;
      box-shadow: 0 8px 20px rgba(0,0,0,0.55), inset 0 0 0 1px rgba(255,255,255,0.03);
    }

    .modal-field textarea:focus {
      border-color: #22c55e;
      box-shadow: 0 0 0 3px rgba(34,197,94,0.18), 0 10px 26px rgba(0,0,0,0.55);
    }

    .modal-actions {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      margin-top: 6px;
    }

    .btn-sm {
      border-radius: 999px;
      border: 1px solid #4b5563;
      background: #020617;
      color: var(--text-main);
      padding: 7px 12px;
      font-size: 0.9rem;
      cursor: pointer;
    }

    .btn-sm-primary {
      border-color: #15803d;
      background: linear-gradient(135deg, #16a34a, #22c55e);
      color: #022c22;
      font-weight: 800;
    }

    .modal-file-label {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 12px;
      border-radius: 999px;
      background: #0b1220;
      border: 1px dashed #475569;
      font-size: 0.9rem;
      cursor: pointer;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,0.03);
    }

    .modal-file-label span { color: var(--text-soft); }
    .modal-file-label:hover { border-style: solid; }
    .modal-file-label input { display: none; }

    .modal-file-name {
      display: block;
      margin-top: 6px;
      font-size: 0.85rem;
      color: var(--text-soft);
    }

    /* MOBILE */
    @media (max-width: 900px) {
      .app-grid { grid-template-columns: 1fr; }
      #map { min-height: 280px; height: 320px; }
      header.app-header { flex-direction: column; align-items: flex-start; }
      .header-right { width: 100%; justify-content: space-between; }
      .user-info { align-items: flex-start; }
      .route-card { grid-template-columns: 1fr; }
      .user-email { max-width: 62vw; }
    }
  </style>
</head>

<body>

<!-- ============ TELA DE AUTENTICA√á√ÉO ============ -->
<div id="auth-screen">
  <header class="auth-header">
    <div class="brand-hero">
      <div class="brand-logo">üêù</div>
      <div class="brand-name">SeeBee</div>
    </div>
  </header>

  <div id="auth-card">
    <h2>Entrar ou criar conta</h2>

    <div class="auth-field">
      <label for="auth-email">E-mail</label>
      <input id="auth-email" type="email" autocomplete="email" />
    </div>

    <div class="auth-field">
      <label for="auth-password">Senha</label>
      <input id="auth-password" type="password" autocomplete="current-password" />
    </div>

    <div class="auth-buttons">
      <button class="btn-primary" id="btn-signin">Entrar</button>
      <button class="btn-outline" id="btn-signup">Criar conta</button>
    </div>

    <button class="btn-google" id="btn-google">
      <span class="btn-google-icon"></span>
      <span>Entrar com Google</span>
    </button>

    <div id="auth-msg" class="auth-msg"></div>
  </div>
</div>

<!-- ============ TELA DO APP ============ -->
<div id="app-screen" class="hidden">
  <header class="app-header">
    <div class="header-left">
      <h1>Rastreador de ninhos</h1>

      <div class="status-pill" id="status-pill">
        <span class="status-dot"></span>
        <span id="cloud-status">Trabalhando online</span>
      </div>
    </div>

    <div class="header-right">
      <div class="user-info">
        <span class="user-email" id="user-email-label"></span>
        <button class="btn-ghost" id="btn-logout">Sair</button>
      </div>

      <div class="brand-mini" title="SeeBee">
        <div class="brand-mini-logo">üêù</div>
        <span>SeeBee</span>
      </div>
    </div>
  </header>

  <div class="app-grid">
    <!-- COLUNA CONTROLES -->
    <section class="card">
      <h3>Trajeto em andamento <span class="badge" id="badge-status">Parado</span></h3>
      <p class="card-subtitle">
        Comece o trajeto, caminhe instalando ninhos e registre cada ponto com foto.
      </p>

      <div class="controls-grid">
        <button class="btn-lg btn-start" id="btn-toggle-route">
          <span id="btn-toggle-icon">‚ñ∂</span>
          <span id="btn-toggle-text">Iniciar trajeto</span>
        </button>

        <button class="btn-lg btn-secondary" id="btn-add-nest" disabled>
          üêù Marcar ninho
        </button>
      </div>

      <div class="info-row">
        <span class="info-pill" id="info-route-name">Trajeto: ‚Äî</span>
        <span class="info-pill" id="info-distance">Dist√¢ncia: 0 m</span>
        <span class="info-pill" id="info-nests">Ninhos: 0</span>
        <span class="info-pill" id="info-gps">GPS: aguardando...</span>
      </div>

      <div class="routes-open-row">
        <button class="btn-small" id="btn-open-routes">Ver trilhas</button>
      </div>
    </section>

    <!-- COLUNA MAPA -->
    <section class="card">
      <h3>Mapa</h3>
      <p class="card-subtitle">
        O mapa acompanha seu caminho. Os ninhos marcados aparecem como alfinetes com foto.
      </p>
      <div id="map"></div>
    </section>
  </div>
</div>

<!-- DRAWER DE TRILHAS -->
<div id="routes-drawer">
  <div class="drawer-card">
    <div class="drawer-header">
      <div>
        <h3>Trilhas gravadas</h3>
        <div class="muted" id="routes-count"></div>
      </div>
      <button class="btn-small" id="btn-close-routes">Fechar</button>
    </div>
    <div id="routes-list"></div>
  </div>
</div>

<!-- MODAL PARA FOTO GRANDE -->
<div id="photo-modal">
  <button id="photo-modal-close">Fechar</button>
  <img id="photo-modal-img" src="" alt="Foto do ninho" />
</div>

<!-- MODAL PARA MARCAR NINHO -->
<div id="nest-modal" class="modal-backdrop">
  <div class="modal-card">
    <h4>Marcar ninho</h4>
    <p>Adicione uma observa√ß√£o e, se quiser, tire uma foto do ninho antes de salvar.</p>

    <div class="modal-field">
      <label for="nest-notes">Observa√ß√µes (opcional)</label>
      <textarea id="nest-notes" placeholder="Ex.: √°rvore grande perto da rua 14..."></textarea>
    </div>

    <div class="modal-field">
      <label>Foto do ninho (opcional)</label>
      <label class="modal-file-label">
        üì∑
        <span>Selecionar ou tirar foto</span>
        <input id="nest-file-input" type="file" accept="image/*" capture="environment" />
      </label>
      <span id="nest-file-name" class="modal-file-name"></span>
    </div>

    <div class="modal-actions">
      <button class="btn-sm" id="nest-cancel">Cancelar</button>
      <button class="btn-sm btn-sm-primary" id="nest-save">Salvar ninho</button>
    </div>
  </div>
</div>

<script>
  /* ======================= CONFIG SUPABASE ======================= */
  const SUPABASE_URL = "https://sgrtyotwnlwpwfecnoze.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNncnR5b3R3bmx3cHdmZWNub3plIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc3NjgxMjcsImV4cCI6MjA4MzM0NDEyN30.QZvTN3mHUwqBwvXeL6q89qNW_4s1Cvopa40nt4TFa9w";
  const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  /* ======================= ESTADO GLOBAL ======================= */
  let map;
  let userMarker;
  let currentRoute = null;
  let watchId = null;
  let pathLayer = null;
  let nestsLayerGroup = null;
  let appInitialized = false;
  let allRoutes = [];
  let isOnline = navigator.onLine;

  const STORAGE_KEY = "seebee_routes_v1";

  /* ======================= ELEMENTOS DOM ======================= */
  const authScreen = document.getElementById("auth-screen");
  const appScreen = document.getElementById("app-screen");
  const authEmailInput = document.getElementById("auth-email");
  const authPasswordInput = document.getElementById("auth-password");
  const authMsg = document.getElementById("auth-msg");
  const btnSignIn = document.getElementById("btn-signin");
  const btnSignUp = document.getElementById("btn-signup");
  const btnGoogle = document.getElementById("btn-google");
  const btnLogout = document.getElementById("btn-logout");
  const userEmailLabel = document.getElementById("user-email-label");

  const statusPill = document.getElementById("status-pill");
  const cloudStatus = document.getElementById("cloud-status");

  const btnToggleRoute = document.getElementById("btn-toggle-route");
  const btnToggleIcon = document.getElementById("btn-toggle-icon");
  const btnToggleText = document.getElementById("btn-toggle-text");
  const btnAddNest = document.getElementById("btn-add-nest");
  const badgeStatus = document.getElementById("badge-status");

  const infoRouteName = document.getElementById("info-route-name");
  const infoDistance = document.getElementById("info-distance");
  const infoNests = document.getElementById("info-nests");
  const infoGps = document.getElementById("info-gps");

  const routesDrawer = document.getElementById("routes-drawer");
  const routesCount = document.getElementById("routes-count");
  const routesListEl = document.getElementById("routes-list");
  const btnOpenRoutes = document.getElementById("btn-open-routes");
  const btnCloseRoutes = document.getElementById("btn-close-routes");

  const photoModal = document.getElementById("photo-modal");
  const photoModalImg = document.getElementById("photo-modal-img");
  const photoModalClose = document.getElementById("photo-modal-close");

  const nestModal = document.getElementById("nest-modal");
  const nestNotes = document.getElementById("nest-notes");
  const nestFileInput = document.getElementById("nest-file-input");
  const nestFileName = document.getElementById("nest-file-name");
  const nestCancel = document.getElementById("nest-cancel");
  const nestSave = document.getElementById("nest-save");

  let pendingNestResolve = null;
  let selectedNestFile = null;

  /* ======================= ONLINE / OFFLINE ======================= */
  function updateOnlineStatus() {
    isOnline = navigator.onLine;

    if (isOnline) {
      statusPill.classList.remove("offline");
      cloudStatus.textContent = "Trabalhando online";
    } else {
      statusPill.classList.add("offline");
      cloudStatus.textContent = "Trabalhando offline";
    }
  }

  window.addEventListener("online", async () => {
    updateOnlineStatus();
    if (appInitialized) await syncRoutes();
  });

  window.addEventListener("offline", () => {
    updateOnlineStatus();
  });

  /* ======================= AUTH ======================= */
  function setAuthMessage(text, isError = false) {
    authMsg.textContent = text || "";
    authMsg.classList.toggle("error", !!text && isError);
    authMsg.classList.toggle("ok", !!text && !isError);
  }

  async function handleSignUp() {
    setAuthMessage("Criando conta...");
    const email = authEmailInput.value.trim();
    const password = authPasswordInput.value;
    if (!email || !password) return setAuthMessage("Preencha e-mail e senha.", true);

    const { error } = await supabaseClient.auth.signUp({ email, password });
    if (error) setAuthMessage(error.message, true);
    else setAuthMessage("Conta criada! Agora clique em Entrar.", false);
  }

  async function handleSignIn() {
    setAuthMessage("Entrando...");
    const email = authEmailInput.value.trim();
    const password = authPasswordInput.value;
    if (!email || !password) return setAuthMessage("Preencha e-mail e senha.", true);

    const { error } = await supabaseClient.auth.signInWithPassword({ email, password });
    if (error) return setAuthMessage(error.message, true);

    setAuthMessage("");
    await checkSession();
  }

  async function handleGoogleSignIn() {
    setAuthMessage("");
    try {
      await supabaseClient.auth.signInWithOAuth({
        provider: "google",
        options: { redirectTo: window.location.origin }
      });
    } catch (e) {
      console.error(e);
      setAuthMessage("N√£o foi poss√≠vel iniciar o login com Google.", true);
    }
  }

  async function handleLogout() {
    await supabaseClient.auth.signOut();
    await checkSession();
  }

  async function checkSession() {
    const { data } = await supabaseClient.auth.getSession();
    const session = data.session;

    if (session) {
      authScreen.classList.add("hidden");
      appScreen.classList.remove("hidden");
      userEmailLabel.textContent = session.user.email || "";

      if (!appInitialized) {
        appInitialized = true;
        initApp();
      }
    } else {
      authScreen.classList.remove("hidden");
      appScreen.classList.add("hidden");
    }
  }

  supabaseClient.auth.onAuthStateChange(() => checkSession());

  btnSignUp.addEventListener("click", handleSignUp);
  btnSignIn.addEventListener("click", handleSignIn);
  btnGoogle.addEventListener("click", handleGoogleSignIn);
  btnLogout.addEventListener("click", handleLogout);

  /* ======================= MAPA ======================= */
  function initMap() {
    map = L.map("map");

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 19,
      attribution: "&copy; OpenStreetMap",
    }).addTo(map);

    nestsLayerGroup = L.layerGroup().addTo(map);

    if ("geolocation" in navigator) {
      navigator.geolocation.getCurrentPosition(
        (pos) => {
          const { latitude, longitude } = pos.coords;
          map.setView([latitude, longitude], 17);
          updateUserMarker(latitude, longitude);
          infoGps.textContent = "GPS: sinal ok";
        },
        () => {
          map.setView([-15.601, -56.097], 13);
          infoGps.textContent = "GPS: n√£o autorizado";
        }
      );
    } else {
      map.setView([-15.601, -56.097], 13);
      infoGps.textContent = "GPS: n√£o dispon√≠vel";
    }

    // Importante: quando abre drawer e volta, o Leaflet √†s vezes precisa recalcular tamanho.
    setTimeout(() => map.invalidateSize(), 250);
  }

  function updateUserMarker(lat, lng) {
    if (!map) return;
    if (!userMarker) {
      userMarker = L.circleMarker([lat, lng], {
        radius: 7,
        color: "#22c55e",
        fillColor: "#22c55e",
        fillOpacity: 0.9,
      }).addTo(map);
    } else {
      userMarker.setLatLng([lat, lng]);
    }
  }

  /* ======================= ROTAS / GRAVA√á√ÉO ======================= */
  function startRoute() {
    if (!navigator.geolocation) {
      alert("Seu dispositivo n√£o suporta GPS.");
      return;
    }

    currentRoute = {
      id: null,
      name: "",
      created_at: new Date().toISOString(),
      path: [],
      nests: [],
      totalDistance: 0,
      synced: isOnline,
    };

    if (pathLayer) { map.removeLayer(pathLayer); pathLayer = null; }
    pathLayer = L.polyline([], { color: "#22c55e", weight: 4 }).addTo(map);
    nestsLayerGroup.clearLayers();

    btnAddNest.disabled = false;
    badgeStatus.textContent = "Gravando";
    badgeStatus.style.background = "#14532d";
    btnToggleText.textContent = "Finalizar trajeto";
    btnToggleIcon.textContent = "‚èπ";
    infoRouteName.textContent = "Trajeto: em grava√ß√£o...";
    infoDistance.textContent = "Dist√¢ncia: 0 m";
    infoNests.textContent = "Ninhos: 0";

    watchId = navigator.geolocation.watchPosition(
      (pos) => {
        const { latitude, longitude } = pos.coords;
        const point = { lat: latitude, lng: longitude, t: new Date().toISOString() };
        currentRoute.path.push(point);

        updateUserMarker(latitude, longitude);
        pathLayer.addLatLng([latitude, longitude]);

        const d = calculateTotalDistance(currentRoute.path);
        currentRoute.totalDistance = d;
        infoDistance.textContent = "Dist√¢ncia: " + d.toFixed(d > 1000 ? 1 : 0) + " m";

        map.panTo([latitude, longitude], { animate: true });
        infoGps.textContent = "GPS: acompanhando...";
      },
      (error) => {
        console.error(error);
        infoGps.textContent = "GPS: erro ao ler posi√ß√£o";
      },
      { enableHighAccuracy: true, maximumAge: 1000, timeout: 10000 }
    );
  }

  async function stopRoute() {
    if (watchId !== null) {
      navigator.geolocation.clearWatch(watchId);
      watchId = null;
    }

    btnAddNest.disabled = true;
    badgeStatus.textContent = "Parado";
    badgeStatus.style.background = "#022c22";
    btnToggleText.textContent = "Iniciar trajeto";
    btnToggleIcon.textContent = "‚ñ∂";

    if (!currentRoute || currentRoute.path.length < 2) {
      alert("Poucos pontos registrados. O trajeto foi descartado.");
      if (pathLayer) { map.removeLayer(pathLayer); pathLayer = null; }
      currentRoute = null;
      infoRouteName.textContent = "Trajeto: ‚Äî";
      infoDistance.textContent = "Dist√¢ncia: 0 m";
      infoNests.textContent = "Ninhos: 0";
      return;
    }

    const now = new Date();
    const defaultName = `Trilha ${now.toLocaleDateString("pt-BR")} ${now.toLocaleTimeString("pt-BR", { hour: "2-digit", minute: "2-digit" })}`;

    const name = prompt("D√™ um nome para esta trilha:", defaultName);
    currentRoute.name = name || defaultName;

    infoRouteName.textContent = "Trajeto: " + currentRoute.name;

    await saveRoute(currentRoute);

    currentRoute = null;
    pathLayer = null;
  }

  function calculateTotalDistance(points) {
    if (points.length < 2) return 0;
    let total = 0;
    for (let i = 1; i < points.length; i++) total += haversineDistance(points[i - 1], points[i]);
    return total;
  }

  function haversineDistance(a, b) {
    const R = 6371000;
    const toRad = (deg) => (deg * Math.PI) / 180;
    const dLat = toRad(b.lat - a.lat);
    const dLng = toRad(b.lng - a.lng);
    const lat1 = toRad(a.lat);
    const lat2 = toRad(b.lat);

    const sinDLat = Math.sin(dLat / 2);
    const sinDLng = Math.sin(dLng / 2);

    const c = sinDLat * sinDLat + Math.cos(lat1) * Math.cos(lat2) * sinDLng * sinDLng;
    const d = 2 * Math.atan2(Math.sqrt(c), Math.sqrt(1 - c));
    return R * d;
  }

  async function handleToggleRoute() {
    if (!currentRoute) startRoute();
    else await stopRoute();
  }

  /* ======================= MODAL NINHO ======================= */
  function openNestModal() {
    selectedNestFile = null;
    nestNotes.value = "";
    nestFileInput.value = "";
    nestFileName.textContent = "";
    nestModal.style.display = "flex";

    return new Promise((resolve) => { pendingNestResolve = resolve; });
  }

  function closeNestModal() {
    nestModal.style.display = "none";
    if (pendingNestResolve) {
      pendingNestResolve(null);
      pendingNestResolve = null;
    }
  }

  nestCancel.addEventListener("click", closeNestModal);

  nestFileInput.addEventListener("change", (ev) => {
    const file = ev.target.files[0];
    selectedNestFile = file || null;
    nestFileName.textContent = file ? file.name : "";
  });

  nestSave.addEventListener("click", () => {
    if (!pendingNestResolve) { nestModal.style.display = "none"; return; }
    const payload = { description: nestNotes.value.trim(), file: selectedNestFile };
    nestModal.style.display = "none";
    pendingNestResolve(payload);
    pendingNestResolve = null;
  });

  async function handleAddNest() {
    if (!currentRoute || currentRoute.path.length === 0) {
      alert("Comece o trajeto antes de marcar um ninho.");
      return;
    }

    const lastPoint = currentRoute.path[currentRoute.path.length - 1];
    const modalResult = await openNestModal();
    if (!modalResult) return;

    const { description, file } = modalResult;
    let photoUrl = null;

    if (file) {
      try {
        const fileExt = file.name.split(".").pop();
        const filePath = "ninho-" + Date.now() + "-" + Math.random().toString(36).slice(2) + "." + fileExt;

        if (isOnline) {
          const { error: uploadError } = await supabaseClient.storage
            .from("ninhos-fotos")
            .upload(filePath, file, { contentType: file.type });

          if (uploadError) {
            console.error(uploadError);
            alert("N√£o foi poss√≠vel enviar a foto para a nuvem. O ninho ser√° salvo sem foto.");
          } else {
            const { data: publicData } = supabaseClient.storage.from("ninhos-fotos").getPublicUrl(filePath);
            photoUrl = publicData.publicUrl;
          }
        } else {
          alert("Voc√™ est√° offline. Por enquanto o ninho ser√° salvo sem foto.");
        }
      } catch (e) {
        console.error(e);
        alert("Erro ao enviar a foto. O ninho ser√° salvo mesmo assim.");
      }
    }

    const nest = {
      lat: lastPoint.lat,
      lng: lastPoint.lng,
      description: description || "",
      photoUrl,
      created_at: new Date().toISOString(),
    };

    currentRoute.nests.push(nest);
    infoNests.textContent = "Ninhos: " + currentRoute.nests.length;

    const marker = L.marker([nest.lat, nest.lng]).addTo(nestsLayerGroup);

    if (photoUrl) {
      marker.bindPopup(
        `<div style="font-size:12px"><strong>Ninho</strong><br><img src="${photoUrl}" style="max-width:140px;border-radius:8px;margin-top:6px;display:block"/><div style="margin-top:6px">${escapeHtml(nest.description || "")}</div></div>`
      );
    } else {
      marker.bindPopup(
        `<div style="font-size:12px"><strong>Ninho</strong><br>${escapeHtml(nest.description || "Sem observa√ß√µes.")}</div>`
      );
    }
  }

  function escapeHtml(str) {
    return String(str || "")
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;")
      .replaceAll('"', "&quot;")
      .replaceAll("'", "&#039;");
  }

  /* ======================= STORAGE / CLOUD / SYNC ======================= */
  function persistLocalRoutes() {
    try { localStorage.setItem(STORAGE_KEY, JSON.stringify(allRoutes)); }
    catch (e) { console.error("Erro ao gravar no localStorage", e); }
  }

  function loadLocalRoutes() {
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return [];
      return JSON.parse(raw);
    } catch (e) {
      console.error("Erro ao ler localStorage", e);
      return [];
    }
  }

  async function loadCloudRoutes() {
    if (!isOnline) return [];
    try {
      const { data, error } = await supabaseClient
        .from("routes")
        .select("*")
        .order("created_at", { ascending: false });

      if (error) throw error;

      return data.map((row) => ({
        id: row.id,
        name: row.name,
        created_at: row.created_at,
        path: row.path || [],
        nests: row.traps || [],
        totalDistance: calculateTotalDistance(row.path || []),
        synced: true,
      }));
    } catch (e) {
      console.error(e);
      return [];
    }
  }

  async function saveRoute(route) {
    allRoutes.push(route);
    persistLocalRoutes();

    if (!isOnline) {
      // offline: marca que n√£o sincronizou
      route.synced = false;
      renderRoutesList();
      return;
    }

    try {
      const { data, error } = await supabaseClient
        .from("routes")
        .insert({ name: route.name, path: route.path, traps: route.nests })
        .select()
        .single();

      if (error) {
        console.error(error);
        route.synced = false;
      } else {
        route.id = data.id;
        route.synced = true;
      }

      persistLocalRoutes();
      renderRoutesList();
    } catch (e) {
      console.error(e);
      route.synced = false;
      persistLocalRoutes();
      renderRoutesList();
    }
  }

  async function syncRoutes() {
    updateOnlineStatus();
    const local = loadLocalRoutes();

    // 1) sobe offline (sem id)
    if (isOnline) {
      for (const r of local) {
        if (!r.id) {
          try {
            const { data, error } = await supabaseClient
              .from("routes")
              .insert({ name: r.name, path: r.path, traps: r.nests })
              .select()
              .single();

            if (!error && data) {
              r.id = data.id;
              r.synced = true;
            }
          } catch (e) {
            console.error("Erro ao sincronizar trajeto offline:", e);
          }
        }
      }
    }

    // 2) baixa nuvem
    const cloud = await loadCloudRoutes();

    // 3) merge
    let merged = [];
    if (isOnline) {
      merged = [...cloud];
      for (const r of local) {
        if (!r.id) merged.push(r);
        else if (!merged.some((c) => c.id === r.id)) merged.push(r);
      }
    } else {
      merged = [...local];
    }

    merged.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
    allRoutes = merged;
    persistLocalRoutes();
    renderRoutesList();
  }

  /* ======================= LISTA (no drawer) ======================= */
  function openRoutesDrawer() {
    renderRoutesList();
    routesDrawer.style.display = "flex";
    setTimeout(() => { if (map) map.invalidateSize(); }, 300);
  }

  function closeRoutesDrawer() {
    routesDrawer.style.display = "none";
    setTimeout(() => { if (map) map.invalidateSize(); }, 220);
  }

  btnOpenRoutes.addEventListener("click", openRoutesDrawer);
  btnCloseRoutes.addEventListener("click", closeRoutesDrawer);

  routesDrawer.addEventListener("click", (e) => {
    if (e.target === routesDrawer) closeRoutesDrawer();
  });

  function getRouteStartEnd(route) {
    const first = route?.path?.[0]?.t ? new Date(route.path[0].t) : null;
    const last = route?.path?.[route.path.length - 1]?.t ? new Date(route.path[route.path.length - 1].t) : null;
    return { first, last };
  }

  function renderRoutesList() {
    routesListEl.innerHTML = "";
    routesCount.textContent = allRoutes.length ? `${allRoutes.length} trilha(s) salva(s)` : "Nenhuma trilha salva";

    if (!allRoutes.length) {
      const div = document.createElement("div");
      div.className = "route-empty";
      div.textContent = "Nenhuma trilha salva ainda. Finalize um trajeto para ele aparecer aqui.";
      routesListEl.appendChild(div);
      return;
    }

    allRoutes.forEach((route, index) => {
      const card = document.createElement("div");
      card.className = "route-card";

      const main = document.createElement("div");
      main.className = "route-main";

      const strong = document.createElement("strong");
      strong.textContent = route.name || "Trilha sem nome";
      main.appendChild(strong);

      const meta = document.createElement("div");
      meta.className = "route-meta";

      const created = new Date(route.created_at || Date.now());
      const { first, last } = getRouteStartEnd(route);

      const startStr = first ? first.toLocaleTimeString("pt-BR", { hour: "2-digit", minute: "2-digit" }) : "‚Äî";
      const endStr = last ? last.toLocaleTimeString("pt-BR", { hour: "2-digit", minute: "2-digit" }) : "‚Äî";

      const syncedLabel = route.id ? "sincronizado" : "n√£o sincronizado";

      meta.innerHTML =
        `${created.toLocaleDateString("pt-BR")} ¬∑ ${startStr} ‚Üí ${endStr}<br>` +
        `${(route.nests?.length || 0)} ninho(s) ¬∑ ${(route.totalDistance || 0).toFixed((route.totalDistance || 0) > 1000 ? 1 : 0)} m ¬∑ <span style="color:${route.id ? "#bbf7d0" : "#facc15"}">${syncedLabel}</span>`;

      main.appendChild(meta);

      if (route.nests && route.nests.length) {
        const thumbsRow = document.createElement("div");
        thumbsRow.className = "thumbs-row";

        route.nests.forEach((nest) => {
          if (!nest.photoUrl) return;
          const img = document.createElement("img");
          img.src = nest.photoUrl;
          img.className = "thumb";
          img.addEventListener("click", () => {
            photoModalImg.src = nest.photoUrl;
            photoModal.style.display = "flex";
          });
          thumbsRow.appendChild(img);
        });

        if (thumbsRow.childElementCount) main.appendChild(thumbsRow);
      }

      const actions = document.createElement("div");
      actions.className = "route-actions";

      const btnVer = document.createElement("button");
      btnVer.className = "btn-xs";
      btnVer.textContent = "Abrir no mapa";
      btnVer.addEventListener("click", () => {
        closeRoutesDrawer();
        showRouteOnMap(route);
      });
      actions.appendChild(btnVer);

      const btnEdit = document.createElement("button");
      btnEdit.className = "btn-xs";
      btnEdit.textContent = "Renomear";
      btnEdit.addEventListener("click", async () => renameRoute(index, route));
      actions.appendChild(btnEdit);

      const btnDelete = document.createElement("button");
      btnDelete.className = "btn-xs danger";
      btnDelete.textContent = "Excluir";
      btnDelete.addEventListener("click", () => deleteRoute(index, route));
      actions.appendChild(btnDelete);

      card.appendChild(main);
      card.appendChild(actions);

      routesListEl.appendChild(card);
    });
  }

  function showRouteOnMap(route) {
    if (!map) return;

    if (pathLayer) { map.removeLayer(pathLayer); pathLayer = null; }
    nestsLayerGroup.clearLayers();

    if (!route.path || !route.path.length) return;

    pathLayer = L.polyline(route.path.map((p) => [p.lat, p.lng]), { color: "#22c55e", weight: 4 }).addTo(map);
    map.fitBounds(pathLayer.getBounds().pad(0.2));

    if (route.nests && route.nests.length) {
      route.nests.forEach((nest) => {
        const marker = L.marker([nest.lat, nest.lng]).addTo(nestsLayerGroup);
        if (nest.photoUrl) {
          marker.bindPopup(
            `<div style="font-size:12px"><strong>Ninho</strong><br><img src="${nest.photoUrl}" style="max-width:140px;border-radius:8px;margin-top:6px;display:block"/><div style="margin-top:6px">${escapeHtml(nest.description || "")}</div></div>`
          );
        } else {
          marker.bindPopup(
            `<div style="font-size:12px"><strong>Ninho</strong><br>${escapeHtml(nest.description || "Sem observa√ß√µes.")}</div>`
          );
        }
      });
    }

    setTimeout(() => map.invalidateSize(), 350);
  }

  async function renameRoute(index, route) {
    const newName = prompt("Novo nome para a trilha:", route.name);
    if (!newName || newName === route.name) return;

    route.name = newName;
    allRoutes[index] = route;
    persistLocalRoutes();
    renderRoutesList();

    if (route.id && isOnline) {
      try {
        await supabaseClient.from("routes").update({ name: newName }).eq("id", route.id);
      } catch (e) { console.error(e); }
    }
  }

  async function deleteRoute(index, route) {
    if (!confirm("Tem certeza que deseja excluir esta trilha?")) return;

    allRoutes.splice(index, 1);
    persistLocalRoutes();
    renderRoutesList();

    if (route.id && isOnline) {
      try { await supabaseClient.from("routes").delete().eq("id", route.id); }
      catch (e) { console.error(e); }
    }
  }

  /* ======================= MODAL FOTO ======================= */
  photoModalClose.addEventListener("click", () => {
    photoModal.style.display = "none";
    photoModalImg.src = "";
  });

  photoModal.addEventListener("click", (e) => {
    if (e.target === photoModal) {
      photoModal.style.display = "none";
      photoModalImg.src = "";
    }
  });

  /* ======================= INICIALIZA√á√ÉO ======================= */
  function initApp() {
    updateOnlineStatus();
    initMap();

    btnToggleRoute.addEventListener("click", handleToggleRoute);
    btnAddNest.addEventListener("click", handleAddNest);

    syncRoutes();
  }

  // Verifica sess√£o na primeira carga
  updateOnlineStatus();
  checkSession();

  // PWA SW
  if ("serviceWorker" in navigator) {
    window.addEventListener("load", () => {
      navigator.serviceWorker.register("./sw.js")
        .catch((err) => console.error("SW registration failed:", err));
    });
  }
</script>
</body>
</html>
