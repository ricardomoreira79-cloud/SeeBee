<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>SeeBee ‚Äì Rastreador de ninhos de abelhas</title>

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#14532d" />

  <!-- PWA -->
  <link rel="manifest" href="manifest.webmanifest" />

  <!-- Leaflet -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <!-- Supabase -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

  <style>
    :root {
      --green-dark: #14532d;
      --green: #16a34a;
      --green-soft: #bbf7d0;
      --bg: #020617;
      --card-bg: #020617;
      --border: #1f2937;
      --text-main: #e5e7eb;
      --text-soft: #9ca3af;
      --danger: #b91c1c;
      --radius-lg: 16px;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #022c22 0, #020617 45%, #000 100%);
      color: var(--text-main);
    }

    button {
      font-family: inherit;
    }

    .hidden {
      display: none !important;
    }

    /* ========= LAYOUT GERAL ========= */

    #auth-screen,
    #app-screen {
      max-width: 1200px;
      margin: 0 auto;
      padding: 16px;
    }

    header.app-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 12px;
    }

    .title-block h1 {
      margin: 0;
      font-size: 1.4rem;
      letter-spacing: 0.03em;
    }

    .title-block p {
      margin: 2px 0 8px;
      font-size: 0.9rem;
      color: var(--text-soft);
    }

    .status-pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 0.8rem;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid #15803d55;
      background: #064e3b;
      color: #bbf7d0;
    }

    .status-pill.offline {
      border-color: #fecaca55;
      background: #7f1d1d;
      color: #fee2e2;
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: #22c55e;
      box-shadow: 0 0 0 4px rgba(34, 197, 94, 0.25);
    }

    .status-pill.offline .status-dot {
      background: #f97316;
      box-shadow: 0 0 0 4px rgba(248, 113, 113, 0.25);
    }

    .user-info {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 4px;
      font-size: 0.8rem;
    }

    .user-email {
      color: var(--text-soft);
    }

    .btn-ghost {
      border-radius: 999px;
      border: 1px solid #4b5563;
      background: transparent;
      color: var(--text-soft);
      padding: 4px 10px;
      font-size: 0.8rem;
      cursor: pointer;
    }

    .btn-ghost:hover {
      border-color: #9ca3af;
      color: #e5e7eb;
    }

    /* ========= HERO / LOGIN ========= */

    .auth-hero {
      margin-top: 24px;
      margin-bottom: 24px;
      text-align: center;
    }

    .logo-circle {
      width: 96px;
      height: 96px;
      margin: 0 auto 12px;
      border-radius: 999px;
      background: radial-gradient(circle at 30% 20%, #facc15, #ea580c 75%);
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow:
        0 0 0 4px rgba(15, 23, 42, 0.9),
        0 20px 40px rgba(0, 0, 0, 0.8);
      font-size: 42px;
    }

    .auth-hero-title {
      margin: 0;
      font-size: 2rem;
      letter-spacing: 0.08em;
    }

    .auth-hero-subtitle {
      margin: 8px 0 0;
      color: var(--text-soft);
      font-size: 0.95rem;
      max-width: 560px;
      margin-left: auto;
      margin-right: auto;
    }

    #auth-card {
      max-width: 460px;
      margin: 0 auto 32px;
      padding: 24px 20px 20px;
      border-radius: var(--radius-lg);
      background: radial-gradient(circle at top left, #04785744, #020617 45%, #000 100%);
      border: 1px solid #1f2937;
      box-shadow: 0 18px 45px rgba(0, 0, 0, 0.75);
    }

    #auth-card h2 {
      margin: 0 0 4px;
      font-size: 1.3rem;
    }

    #auth-card p {
      margin: 0 0 20px;
      color: var(--text-soft);
      font-size: 0.9rem;
    }

    .auth-field {
      margin-bottom: 14px;
    }

    .auth-field label {
      display: block;
      font-size: 0.8rem;
      margin-bottom: 4px;
      color: var(--text-soft);
    }

    .auth-field input {
      width: 100%;
      padding: 8px 10px;
      border-radius: 9px;
      border: 1px solid #374151;
      background: #020617;
      color: var(--text-main);
      font-size: 0.9rem;
    }

    .auth-buttons {
      display: flex;
      gap: 8px;
      margin-top: 4px;
    }

    .btn-primary {
      flex: 1;
      background: linear-gradient(135deg, var(--green), #22c55e);
      border: none;
      padding: 8px 10px;
      border-radius: 999px;
      color: #022c22;
      font-weight: 600;
      cursor: pointer;
      font-size: 0.9rem;
    }

    .btn-outline {
      flex: 1;
      background: transparent;
      border-radius: 999px;
      border: 1px solid #4b5563;
      color: var(--text-main);
      cursor: pointer;
      font-size: 0.9rem;
    }

    .btn-google {
      margin-top: 10px;
      width: 100%;
      padding: 9px 12px;
      border-radius: 999px;
      border: 1px solid #1f2937;
      background: #020617;
      color: var(--text-main);
      font-size: 0.9rem;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      cursor: pointer;
    }

    .btn-google-icon {
      width: 18px;
      height: 18px;
      border-radius: 4px;
      background: conic-gradient(
        from 45deg,
        #4285f4 0 25%,
        #34a853 25% 50%,
        #fbbc05 50% 75%,
        #ea4335 75% 100%
      );
    }

    .auth-msg {
      margin-top: 12px;
      font-size: 0.8rem;
      min-height: 16px;
    }

    .auth-msg.error {
      color: #fecaca;
    }

    .auth-msg.ok {
      color: #bbf7d0;
    }

    /* ========= APP ========= */

    .app-grid {
      display: grid;
      grid-template-columns: minmax(260px, 320px) minmax(0, 1fr);
      gap: 12px;
      align-items: stretch;
    }

    .card {
      background: radial-gradient(circle at top left, #065f4633, #020617 60%, #000 100%);
      border-radius: var(--radius-lg);
      border: 1px solid var(--border);
      padding: 14px 14px 12px;
      box-shadow: 0 16px 40px rgba(0, 0, 0, 0.8);
    }

    .card h3 {
      margin: 0 0 8px;
      font-size: 1rem;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .card-subtitle {
      margin: 0 0 12px;
      font-size: 0.8rem;
      color: var(--text-soft);
    }

    .badge {
      font-size: 0.7rem;
      padding: 2px 6px;
      border-radius: 999px;
      background: #022c22;
      color: #bbf7d0;
      border: 1px solid #14532d;
    }

    .controls-grid {
      display: grid;
      grid-template-columns: 1.6fr 1.4fr;
      gap: 8px;
      margin-bottom: 10px;
    }

    .btn-lg {
      width: 100%;
      border-radius: 999px;
      padding: 10px 12px;
      border: none;
      font-size: 0.95rem;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }

    .btn-start {
      background: linear-gradient(135deg, #16a34a, #22c55e);
      color: #022c22;
      box-shadow: 0 0 0 1px #15803d, 0 10px 25px rgba(16, 185, 129, 0.55);
    }

    .btn-stop {
      background: linear-gradient(135deg, #b91c1c, #f97316);
      color: #fff7ed;
      box-shadow: 0 0 0 1px #b91c1c, 0 10px 25px rgba(248, 113, 113, 0.6);
    }

    .btn-secondary {
      background: #020617;
      color: var(--text-main);
      border: 1px solid #4b5563;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.75);
    }

    .info-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      font-size: 0.8rem;
      color: var(--text-soft);
      padding-top: 2px;
      border-top: 1px dashed #1f2937;
      margin-top: 10px;
    }

    .info-pill {
      padding: 2px 8px;
      border-radius: 999px;
      background: #020617;
      border: 1px solid #1f2937;
    }

    /* MAPA */

    #map {
      width: 100%;
      min-height: 320px;
      height: 100%;
      border-radius: var(--radius-lg);
      overflow: hidden;
    }

    .leaflet-container {
      background: #020617;
    }

    /* LISTA DE TRAJETOS */

    .routes-section {
      margin-top: 12px;
      margin-bottom: 32px;
    }

    .routes-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 6px;
      margin-bottom: 6px;
    }

    .routes-header h3 {
      margin: 0;
      font-size: 0.95rem;
    }

    .route-empty {
      font-size: 0.8rem;
      color: var(--text-soft);
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px dashed #1f2937;
      background: #02061766;
    }

    .route-card {
      margin-top: 6px;
      border-radius: 12px;
      border: 1px solid #1f2937;
      background: #020617d9;
      padding: 8px 10px 6px;
      font-size: 0.8rem;
      display: grid;
      grid-template-columns: 1.5fr 1.1fr;
      gap: 8px;
      align-items: flex-start;
    }

    .route-main strong {
      display: block;
      margin-bottom: 2px;
    }

    .route-meta {
      color: var(--text-soft);
      font-size: 0.75rem;
    }

    .route-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      justify-content: flex-end;
    }

    .btn-xs {
      border-radius: 999px;
      border: 1px solid #4b5563;
      background: #020617;
      color: var(--text-soft);
      padding: 3px 8px;
      font-size: 0.75rem;
      cursor: pointer;
    }

    .btn-xs.danger {
      border-color: #7f1d1d;
      color: #fecaca;
    }

    .thumb {
      width: 40px;
      height: 40px;
      object-fit: cover;
      border-radius: 6px;
      border: 1px solid #1f2937;
      cursor: pointer;
    }

    .thumbs-row {
      display: flex;
      gap: 4px;
      margin-top: 3px;
      flex-wrap: wrap;
    }

    /* MODAL IMAGEM */

    #photo-modal {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.85);
      z-index: 9999;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 16px;
    }

    #photo-modal img {
      max-width: 100%;
      max-height: 100%;
      border-radius: 12px;
      box-shadow: 0 20px 50px rgba(0, 0, 0, 0.9);
    }

    #photo-modal-close {
      position: fixed;
      top: 16px;
      right: 16px;
      border-radius: 999px;
      border: none;
      background: #020617;
      color: #e5e7eb;
      padding: 6px 10px;
      cursor: pointer;
      font-size: 0.8rem;
      border: 1px solid #4b5563;
    }

    /* MOBILE */

    @media (max-width: 900px) {
      .app-grid {
        grid-template-columns: 1fr;
      }
      #map {
        min-height: 260px;
      }
      header.app-header {
        flex-direction: column;
        align-items: flex-start;
      }
      .user-info {
        align-items: flex-start;
      }
      .route-card {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>

<!-- ============ TELA DE AUTENTICA√á√ÉO ============ -->
<div id="auth-screen">
  <div class="auth-hero">
    <div class="logo-circle">üêù</div>
    <h1 class="auth-hero-title">SeeBee</h1>
    <p class="auth-hero-subtitle">
      Fa√ßa login para registrar trajetos, marcar ninhos com foto e consultar tudo depois
      com seguran√ßa na nuvem.
    </p>
  </div>

  <div id="auth-card">
    <h2>Entrar ou criar conta</h2>
    <p>Use um e-mail e senha ou conecte com sua conta Google para salvar seus trajetos na nuvem.</p>

    <div class="auth-field">
      <label for="auth-email">E-mail</label>
      <input id="auth-email" type="email" autocomplete="email" />
    </div>

    <div class="auth-field">
      <label for="auth-password">Senha</label>
      <input id="auth-password" type="password" autocomplete="current-password" />
    </div>

    <div class="auth-buttons">
      <button class="btn-primary" id="btn-signin">Entrar</button>
      <button class="btn-outline" id="btn-signup">Criar conta</button>
    </div>

    <button class="btn-google" id="btn-google-auth">
      <span class="btn-google-icon"></span>
      <span>Entrar com Google</span>
    </button>

    <div id="auth-msg" class="auth-msg"></div>
  </div>
</div>

<!-- ============ TELA DO APP ============ -->
<div id="app-screen" class="hidden">
  <header class="app-header">
    <div class="title-block">
      <h1>SeeBee ‚Äì Rastreador de ninhos de abelhas</h1>
      <p>Registre seus trajetos, marque ninhos com foto e consulte depois.</p>
      <div class="status-pill" id="status-pill">
        <span class="status-dot"></span>
        <span id="cloud-status">Conectado √† nuvem (Supabase)</span>
      </div>
    </div>

    <div class="user-info">
      <span class="user-email" id="user-email-label"></span>
      <button class="btn-ghost" id="btn-logout">Sair</button>
    </div>
  </header>

  <div class="app-grid">
    <!-- COLUNA CONTROLES -->
    <section class="card">
      <h3>Trajeto em andamento <span class="badge" id="badge-status">Parado</span></h3>
      <p class="card-subtitle">
        Comece o trajeto, caminhe instalando ninhos e registre cada ponto com foto.
      </p>

      <div class="controls-grid">
        <button class="btn-lg btn-start" id="btn-toggle-route">
          <span id="btn-toggle-icon">‚ñ∂</span>
          <span id="btn-toggle-text">Iniciar trajeto</span>
        </button>

        <button class="btn-lg btn-secondary" id="btn-add-nest" disabled>
          üêù Marcar ninho
        </button>
      </div>

      <div class="info-row">
        <span class="info-pill" id="info-route-name">Trajeto: ‚Äî</span>
        <span class="info-pill" id="info-distance">Dist√¢ncia: 0 m</span>
        <span class="info-pill" id="info-nests">Ninhos: 0</span>
        <span class="info-pill" id="info-gps">GPS: aguardando...</span>
      </div>
    </section>

    <!-- COLUNA MAPA -->
    <section class="card">
      <h3>Mapa</h3>
      <p class="card-subtitle">
        O mapa acompanha seu caminho. Os ninhos marcados aparecem como alfinetes com foto.
      </p>
      <div id="map"></div>
    </section>
  </div>

  <!-- LISTA DE TRAJETOS -->
  <section class="routes-section">
    <div class="routes-header">
      <h3>Trajetos salvos</h3>
    </div>
    <div id="routes-list"></div>
  </section>
</div>

<!-- MODAL PARA FOTO GRANDE -->
<div id="photo-modal">
  <button id="photo-modal-close">Fechar</button>
  <img id="photo-modal-img" src="" alt="Foto do ninho" />
</div>

<script>
  /* ======================= CONFIG SUPABASE ======================= */

  const SUPABASE_URL = "https://sgrtyotwnlwpwfecnoze.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNncnR5b3R3bmx3cHdmZWNub3plIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc3NjgxMjcsImV4cCI6MjA4MzM0NDEyN30.QZvTN3mHUwqBwvXeL6q89qNW_4s1Cvopa40nt4TFa9w";

  const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  /* ======================= ESTADO GLOBAL ======================= */

  let map;
  let userMarker;
  let currentRoute = null;
  let watchId = null;
  let pathLayer = null;
  let nestsLayerGroup = null;
  let appInitialized = false;
  let allRoutes = []; // carregados da nuvem + localStorage

  let isOnline = navigator.onLine;

  const STORAGE_KEY = "seebee_routes_v1";

  /* ======================= ELEMENTOS DOM ======================= */

  const authScreen = document.getElementById("auth-screen");
  const appScreen = document.getElementById("app-screen");
  const authEmailInput = document.getElementById("auth-email");
  const authPasswordInput = document.getElementById("auth-password");
  const authMsg = document.getElementById("auth-msg");
  const btnSignIn = document.getElementById("btn-signin");
  const btnSignUp = document.getElementById("btn-signup");
  const btnGoogleAuth = document.getElementById("btn-google-auth");
  const btnLogout = document.getElementById("btn-logout");
  const userEmailLabel = document.getElementById("user-email-label");

  const btnToggleRoute = document.getElementById("btn-toggle-route");
  const btnToggleIcon = document.getElementById("btn-toggle-icon");
  const btnToggleText = document.getElementById("btn-toggle-text");
  const btnAddNest = document.getElementById("btn-add-nest");
  const badgeStatus = document.getElementById("badge-status");

  const infoRouteName = document.getElementById("info-route-name");
  const infoDistance = document.getElementById("info-distance");
  const infoNests = document.getElementById("info-nests");
  const infoGps = document.getElementById("info-gps");
  const cloudStatus = document.getElementById("cloud-status");
  const statusPill = document.getElementById("status-pill");

  const routesListEl = document.getElementById("routes-list");

  const photoModal = document.getElementById("photo-modal");
  const photoModalImg = document.getElementById("photo-modal-img");
  const photoModalClose = document.getElementById("photo-modal-close");

  /* ======================= ONLINE / OFFLINE ======================= */

  function updateCloudStatus() {
    if (isOnline) {
      cloudStatus.textContent = "Conectado √† nuvem (Supabase)";
      statusPill.classList.remove("offline");
    } else {
      cloudStatus.textContent =
        "Offline ‚Äì dados s√≥ neste aparelho (sincronizaremos depois)";
      statusPill.classList.add("offline");
    }
  }

  async function handleConnectivityChange() {
    isOnline = navigator.onLine;
    updateCloudStatus();

    // Se voltar a ficar online e o app j√° estiver rodando, tenta sincronizar
    if (isOnline && appInitialized) {
      await syncRoutes();
    }
  }

  window.addEventListener("online", handleConnectivityChange);
  window.addEventListener("offline", handleConnectivityChange);

  updateCloudStatus();

  /* ======================= AUTENTICA√á√ÉO ======================= */

  function setAuthMessage(text, isError = false) {
    authMsg.textContent = text || "";
    authMsg.classList.toggle("error", !!text && isError);
    authMsg.classList.toggle("ok", !!text && !isError);
  }

  async function handleSignUp() {
    setAuthMessage("Criando conta...");
    const email = authEmailInput.value.trim();
    const password = authPasswordInput.value;

    if (!email || !password) {
      setAuthMessage("Preencha e-mail e senha.", true);
      return;
    }

    const { error } = await supabaseClient.auth.signUp({ email, password });
    if (error) {
      setAuthMessage(error.message, true);
    } else {
      setAuthMessage("Conta criada! Agora √© s√≥ clicar em Entrar.", false);
    }
  }

  async function handleSignIn() {
    setAuthMessage("Entrando...");
    const email = authEmailInput.value.trim();
    const password = authPasswordInput.value;

    if (!email || !password) {
      setAuthMessage("Preencha e-mail e senha.", true);
      return;
    }

    const { data, error } = await supabaseClient.auth.signInWithPassword({
      email,
      password,
    });

    if (error) {
      setAuthMessage(error.message, true);
      return;
    }

    setAuthMessage("");
    await checkSession();
  }

  async function handleGoogleSignIn() {
    setAuthMessage("Redirecionando para o Google...");
    try {
      const { error } = await supabaseClient.auth.signInWithOAuth({
        provider: "google",
        options: {
          redirectTo: window.location.origin,
        },
      });
      if (error) {
        setAuthMessage(error.message, true);
      }
    } catch (e) {
      console.error(e);
      setAuthMessage("Erro ao iniciar login com Google.", true);
    }
  }

  async function handleLogout() {
    await supabaseClient.auth.signOut();
    await checkSession();
  }

  async function checkSession() {
    const { data } = await supabaseClient.auth.getSession();
    const session = data.session;

    if (session) {
      // Usu√°rio logado
      authScreen.classList.add("hidden");
      appScreen.classList.remove("hidden");
      userEmailLabel.textContent = session.user.email || "";
      if (!appInitialized) {
        appInitialized = true;
        initApp();
      }
    } else {
      // Sem login
      authScreen.classList.remove("hidden");
      appScreen.classList.add("hidden");
    }
  }

  supabaseClient.auth.onAuthStateChange(() => {
    checkSession();
  });

  btnSignUp.addEventListener("click", handleSignUp);
  btnSignIn.addEventListener("click", handleSignIn);
  btnGoogleAuth.addEventListener("click", handleGoogleSignIn);
  btnLogout.addEventListener("click", handleLogout);

  /* ======================= APP PRINCIPAL ======================= */

  function initMap() {
    map = L.map("map");

    // Tile layer OSM
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 19,
      attribution: "&copy; OpenStreetMap",
    }).addTo(map);

    nestsLayerGroup = L.layerGroup().addTo(map);

    // Posi√ß√£o inicial: tenta usar GPS
    if ("geolocation" in navigator) {
      navigator.geolocation.getCurrentPosition(
        (pos) => {
          const { latitude, longitude } = pos.coords;
          map.setView([latitude, longitude], 17);
          updateUserMarker(latitude, longitude);
          infoGps.textContent = "GPS: sinal ok";
        },
        () => {
          map.setView([-15.601, -56.097], 13); // fallback Cuiab√°
          infoGps.textContent = "GPS: n√£o autorizado";
        }
      );
    } else {
      map.setView([-15.601, -56.097], 13);
      infoGps.textContent = "GPS: n√£o dispon√≠vel";
    }
  }

  function updateUserMarker(lat, lng) {
    if (!map) return;
    if (!userMarker) {
      userMarker = L.circleMarker([lat, lng], {
        radius: 7,
        color: "#22c55e",
        fillColor: "#22c55e",
        fillOpacity: 0.9,
      }).addTo(map);
    } else {
      userMarker.setLatLng([lat, lng]);
    }
  }

  function startRoute() {
    if (!navigator.geolocation) {
      alert("Seu dispositivo n√£o suporta GPS.");
      return;
    }

    currentRoute = {
      id: null, // ID da nuvem, se salvar
      name: "",
      created_at: new Date().toISOString(),
      path: [],
      nests: [],
      totalDistance: 0,
      synced: false, // assume que come√ßa n√£o sincronizado
    };

    pathLayer = L.polyline([], {
      color: "#22c55e",
      weight: 4,
    }).addTo(map);

    nestsLayerGroup.clearLayers();

    btnAddNest.disabled = false;
    badgeStatus.textContent = "Gravando";
    badgeStatus.style.background = "#14532d";
    btnToggleText.textContent = "Finalizar trajeto";
    btnToggleIcon.textContent = "‚èπ";
    infoRouteName.textContent = "Trajeto: em grava√ß√£o...";
    infoDistance.textContent = "Dist√¢ncia: 0 m";
    infoNests.textContent = "Ninhos: 0";

    watchId = navigator.geolocation.watchPosition(
      (pos) => {
        const { latitude, longitude } = pos.coords;
        const point = {
          lat: latitude,
          lng: longitude,
          t: new Date().toISOString(),
        };
        currentRoute.path.push(point);

        updateUserMarker(latitude, longitude);
        pathLayer.addLatLng([latitude, longitude]);

        // Atualiza dist√¢ncia
        const d = calculateTotalDistance(currentRoute.path);
        currentRoute.totalDistance = d;
        infoDistance.textContent =
          "Dist√¢ncia: " + d.toFixed(d > 1000 ? 1 : 0) + " m";

        // Mant√©m mapa perto do usu√°rio
        map.panTo([latitude, longitude], { animate: true });
        infoGps.textContent = "GPS: acompanhando...";
      },
      (error) => {
        console.error(error);
        infoGps.textContent = "GPS: erro ao ler posi√ß√£o";
      },
      {
        enableHighAccuracy: true,
        maximumAge: 1000,
        timeout: 10000,
      }
    );
  }

  async function stopRoute() {
    if (watchId !== null) {
      navigator.geolocation.clearWatch(watchId);
      watchId = null;
    }

    btnAddNest.disabled = true;
    badgeStatus.textContent = "Parado";
    badgeStatus.style.background = "#022c22";
    btnToggleText.textContent = "Iniciar trajeto";
    btnToggleIcon.textContent = "‚ñ∂";

    if (!currentRoute || currentRoute.path.length < 2) {
      alert("Poucos pontos registrados. O trajeto foi descartado.");
      if (pathLayer) {
        map.removeLayer(pathLayer);
        pathLayer = null;
      }
      currentRoute = null;
      infoRouteName.textContent = "Trajeto: ‚Äî";
      infoDistance.textContent = "Dist√¢ncia: 0 m";
      infoNests.textContent = "Ninhos: 0";
      return;
    }

    const defaultName = `Trajeto em ${new Date().toLocaleDateString(
      "pt-BR"
    )} ${new Date().toLocaleTimeString("pt-BR", {
      hour: "2-digit",
      minute: "2-digit",
    })}`;

    const name = prompt("D√™ um nome para este trajeto:", defaultName);
    if (!name) {
      alert("Trajeto salvo como rascunho local.");
      currentRoute.name = defaultName;
    } else {
      currentRoute.name = name;
    }

    infoRouteName.textContent = "Trajeto: " + currentRoute.name;

    await saveRoute(currentRoute);

    currentRoute = null;
    pathLayer = null;
  }

  function calculateTotalDistance(points) {
    if (points.length < 2) return 0;
    let total = 0;
    for (let i = 1; i < points.length; i++) {
      total += haversineDistance(points[i - 1], points[i]);
    }
    return total;
  }

  function haversineDistance(a, b) {
    const R = 6371000;
    const toRad = (deg) => (deg * Math.PI) / 180;
    const dLat = toRad(b.lat - a.lat);
    const dLng = toRad(b.lng - a.lng);
    const lat1 = toRad(a.lat);
    const lat2 = toRad(b.lat);

    const sinDLat = Math.sin(dLat / 2);
    const sinDLng = Math.sin(dLng / 2);

    const c =
      sinDLat * sinDLat +
      Math.cos(lat1) * Math.cos(lat2) * sinDLng * sinDLng;
    const d = 2 * Math.atan2(Math.sqrt(c), Math.sqrt(1 - c));
    return R * d;
  }

  async function handleToggleRoute() {
    if (!currentRoute) {
      startRoute();
    } else {
      await stopRoute();
    }
  }

  async function handleAddNest() {
    if (!currentRoute || currentRoute.path.length === 0) {
      alert("Comece o trajeto antes de marcar um ninho.");
      return;
    }

    const lastPoint = currentRoute.path[currentRoute.path.length - 1];

    const description = prompt(
      "Alguma observa√ß√£o sobre este ninho? (opcional)",
      ""
    );

    const input = document.createElement("input");
    input.type = "file";
    input.accept = "image/*";
    input.capture = "environment";

    input.onchange = async (ev) => {
      const file = ev.target.files[0];
      let photoUrl = null;

      if (file && isOnline) {
        try {
          const fileExt = file.name.split(".").pop();
          const filePath =
            "ninho-" +
            Date.now() +
            "-" +
            Math.random().toString(36).slice(2) +
            "." +
            fileExt;

          const { error: uploadError } = await supabaseClient.storage
            .from("ninhos-fotos")
            .upload(filePath, file, { contentType: file.type });

          if (uploadError) {
            console.error(uploadError);
            alert(
              "N√£o foi poss√≠vel enviar a foto para a nuvem. O ninho ser√° salvo sem foto."
            );
          } else {
            const { data: publicData } = supabaseClient.storage
              .from("ninhos-fotos")
              .getPublicUrl(filePath);
            photoUrl = publicData.publicUrl;
          }
        } catch (e) {
          console.error(e);
          alert("Erro ao enviar a foto. O ninho ser√° salvo mesmo assim.");
        }
      } else if (file && !isOnline) {
        alert(
          "Voc√™ est√° offline: o ninho ser√° salvo sem foto. (Foto em nuvem precisa de conex√£o.)"
        );
      }

      const nest = {
        lat: lastPoint.lat,
        lng: lastPoint.lng,
        description: description || "",
        photoUrl,
        created_at: new Date().toISOString(),
      };

      currentRoute.nests.push(nest);
      infoNests.textContent = "Ninhos: " + currentRoute.nests.length;

      const marker = L.marker([nest.lat, nest.lng]).addTo(nestsLayerGroup);

      if (photoUrl) {
        marker.bindPopup(
          `<div style="font-size:12px"><strong>Ninho</strong><br><img src="${photoUrl}" style="max-width:120px;border-radius:6px;margin-top:4px"/><br>${
            nest.description || ""
          }</div>`
        );
      } else {
        marker.bindPopup(
          `<div style="font-size:12px"><strong>Ninho</strong><br>${
            nest.description || "Sem observa√ß√µes."
          }</div>`
        );
      }
    };

    input.click();
  }

  /* ======================= SALVAR & CARREGAR ======================= */

  async function saveRoute(route) {
    // Garante flags
    if (typeof route.synced === "undefined") {
      route.synced = false;
    }

    // Salva local
    allRoutes.push(route);
    persistLocalRoutes();
    renderRoutesList();

    if (!isOnline) {
      updateCloudStatus();
      return;
    }

    // Tenta salvar na nuvem
    try {
      const { data, error } = await supabaseClient
        .from("routes")
        .insert({
          name: route.name,
          path: route.path,
          traps: route.nests,
          created_at: route.created_at,
        })
        .select()
        .single();

      if (error) {
        console.error(error);
        cloudStatus.textContent =
          "Erro ao salvar na nuvem (usando c√≥pia local).";
        route.synced = false;
      } else {
        route.id = data.id;
        route.synced = true;
        cloudStatus.textContent = "Conectado √† nuvem (Supabase)";
        persistLocalRoutes();
        renderRoutesList();
      }
    } catch (e) {
      console.error(e);
      cloudStatus.textContent =
        "Erro ao salvar na nuvem (usando c√≥pia local).";
      route.synced = false;
    }
  }

  function persistLocalRoutes() {
    try {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(allRoutes));
    } catch (e) {
      console.error("Erro ao gravar no localStorage", e);
    }
  }

  function loadLocalRoutes() {
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return [];
      const parsed = JSON.parse(raw);
      // Garante flags coerentes
      parsed.forEach((r) => {
        if (typeof r.synced === "undefined") {
          r.synced = !!r.id;
        }
      });
      return parsed;
    } catch (e) {
      console.error("Erro ao ler localStorage", e);
      return [];
    }
  }

  async function loadCloudRoutes() {
    if (!isOnline) {
      return [];
    }
    try {
      const { data, error } = await supabaseClient
        .from("routes")
        .select("*")
        .order("created_at", { ascending: false });

      if (error) throw error;

      return data.map((row) => ({
        id: row.id,
        name: row.name,
        created_at: row.created_at,
        path: row.path || [],
        nests: row.traps || [],
        totalDistance: calculateTotalDistance(row.path || []),
        synced: true,
      }));
    } catch (e) {
      console.error(e);
      cloudStatus.textContent =
        "Erro ao ler dados da nuvem (mostrando s√≥ dados locais).";
      return [];
    }
  }

  async function syncRoutes() {
    const local = loadLocalRoutes();

    if (!isOnline) {
      allRoutes = local;
      updateCloudStatus();
      renderRoutesList();
      return;
    }

    // 1) Sobe para nuvem todos os trajetos sem id / n√£o sincronizados
    for (const route of local) {
      const needsSync = !route.id || route.synced === false;
      if (!needsSync) continue;

      try {
        const { data, error } = await supabaseClient
          .from("routes")
          .insert({
            name: route.name,
            path: route.path,
            traps: route.nests,
            created_at: route.created_at,
          })
          .select()
          .single();

        if (!error && data) {
          route.id = data.id;
          route.synced = true;
        } else if (error) {
          console.error("Erro ao sincronizar trajeto:", error);
        }
      } catch (e) {
        console.error("Erro ao sincronizar trajeto:", e);
      }
    }

    // 2) Busca tudo que est√° na nuvem
    const cloud = await loadCloudRoutes();

    // 3) Mescla com o local (usando id quando existir)
    const merged = [...cloud];

    for (const r of local) {
      const exists = r.id && merged.some((c) => c.id === r.id);
      if (!exists) {
        merged.push(r);
      }
    }

    // Ordena por data desc
    merged.sort(
      (a, b) => new Date(b.created_at) - new Date(a.created_at)
    );

    allRoutes = merged;
    persistLocalRoutes();
    renderRoutesList();
  }

  /* ======================= LISTA DE TRAJETOS ======================= */

  function renderRoutesList() {
    routesListEl.innerHTML = "";

    if (!allRoutes.length) {
      const div = document.createElement("div");
      div.className = "route-empty";
      div.textContent =
        "Nenhum trajeto salvo ainda. Depois de finalizar um trajeto ele aparecer√° aqui.";
      routesListEl.appendChild(div);
      return;
    }

    allRoutes.forEach((route, index) => {
      const card = document.createElement("div");
      card.className = "route-card";

      const main = document.createElement("div");
      main.className = "route-main";

      const strong = document.createElement("strong");
      strong.textContent = route.name || "Trajeto sem nome";
      main.appendChild(strong);

      const meta = document.createElement("div");
      meta.className = "route-meta";

      const date = new Date(route.created_at || Date.now());

      let metaText =
        date.toLocaleDateString("pt-BR") +
        " ¬∑ " +
        date.toLocaleTimeString("pt-BR", {
          hour: "2-digit",
          minute: "2-digit",
        }) +
        " ¬∑ " +
        (route.totalDistance || 0).toFixed(
          (route.totalDistance || 0) > 1000 ? 1 : 0
        ) +
        " m ¬∑ " +
        (route.nests?.length || 0) +
        " ninhos";

      const unsynced = !route.id || route.synced === false;
      if (unsynced) {
        metaText += " ¬∑ n√£o sincronizado (s√≥ neste aparelho)";
      }

      meta.textContent = metaText;

      main.appendChild(meta);

      // Thumbs
      if (route.nests && route.nests.length) {
        const thumbsRow = document.createElement("div");
        thumbsRow.className = "thumbs-row";
        route.nests.forEach((nest) => {
          if (!nest.photoUrl) return;
          const img = document.createElement("img");
          img.src = nest.photoUrl;
          img.className = "thumb";
          img.addEventListener("click", () => {
            photoModalImg.src = nest.photoUrl;
            photoModal.style.display = "flex";
          });
          thumbsRow.appendChild(img);
        });
        if (thumbsRow.childElementCount) {
          main.appendChild(thumbsRow);
        }
      }

      const actions = document.createElement("div");
      actions.className = "route-actions";

      const btnVer = document.createElement("button");
      btnVer.className = "btn-xs";
      btnVer.textContent = "Ver no mapa";
      btnVer.addEventListener("click", () => showRouteOnMap(route));
      actions.appendChild(btnVer);

      const btnEdit = document.createElement("button");
      btnEdit.className = "btn-xs";
      btnEdit.textContent = "Renomear";
      btnEdit.addEventListener("click", async () =>
        renameRoute(index, route)
      );
      actions.appendChild(btnEdit);

      const btnDelete = document.createElement("button");
      btnDelete.className = "btn-xs danger";
      btnDelete.textContent = "Excluir";
      btnDelete.addEventListener("click", () =>
        deleteRoute(index, route)
      );
      actions.appendChild(btnDelete);

      card.appendChild(main);
      card.appendChild(actions);

      routesListEl.appendChild(card);
    });
  }

  function showRouteOnMap(route) {
    if (!map) return;

    if (pathLayer) {
      map.removeLayer(pathLayer);
      pathLayer = null;
    }
    nestsLayerGroup.clearLayers();

    if (!route.path || !route.path.length) return;

    pathLayer = L.polyline(
      route.path.map((p) => [p.lat, p.lng]),
      { color: "#22c55e", weight: 4 }
    ).addTo(map);

    const bounds = pathLayer.getBounds();
    map.fitBounds(bounds.pad(0.2));

    if (route.nests && route.nests.length) {
      route.nests.forEach((nest) => {
        const marker = L.marker([nest.lat, nest.lng]).addTo(
          nestsLayerGroup
        );
        if (nest.photoUrl) {
          marker.bindPopup(
            `<div style="font-size:12px"><strong>Ninho</strong><br><img src="${nest.photoUrl}" style="max-width:120px;border-radius:6px;margin-top:4px"/><br>${
              nest.description || ""
            }</div>`
          );
        } else {
          marker.bindPopup(
            `<div style="font-size:12px"><strong>Ninho</strong><br>${
              nest.description || "Sem observa√ß√µes."
            }</div>`
          );
        }
      });
    }
  }

  async function renameRoute(index, route) {
    const newName = prompt("Novo nome para o trajeto:", route.name);
    if (!newName || newName === route.name) return;

    route.name = newName;
    allRoutes[index] = route;
    persistLocalRoutes();
    renderRoutesList();

    if (route.id && isOnline) {
      try {
        await supabaseClient
          .from("routes")
          .update({ name: newName })
          .eq("id", route.id);
      } catch (e) {
        console.error(e);
      }
    } else if (!route.id) {
      route.synced = false;
      persistLocalRoutes();
    }
  }

  async function deleteRoute(index, route) {
    if (!confirm("Tem certeza que deseja excluir este trajeto?")) return;

    allRoutes.splice(index, 1);
    persistLocalRoutes();
    renderRoutesList();

    if (route.id && isOnline) {
      try {
        await supabaseClient.from("routes").delete().eq("id", route.id);
      } catch (e) {
        console.error(e);
      }
    }
  }

  /* ======================= MODAL FOTO ======================= */

  photoModalClose.addEventListener("click", () => {
    photoModal.style.display = "none";
    photoModalImg.src = "";
  });

  photoModal.addEventListener("click", (e) => {
    if (e.target === photoModal) {
      photoModal.style.display = "none";
      photoModalImg.src = "";
    }
  });

  /* ======================= INICIALIZA√á√ÉO ======================= */

  function initApp() {
    initMap();

    btnToggleRoute.addEventListener("click", handleToggleRoute);
    btnAddNest.addEventListener("click", handleAddNest);

    syncRoutes();
  }

  // Verifica sess√£o na primeira carga
  checkSession();

  // Service Worker (PWA)
  if ("serviceWorker" in navigator) {
    window.addEventListener("load", () => {
      navigator.serviceWorker
        .register("./sw.js")
        .catch((err) => console.error("SW registration failed:", err));
    });
  }
</script>
</body>
</html>
