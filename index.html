<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Ninhos de Abelhas ‚Äì Rastreador</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />

  <style>
    :root {
      --green-dark: #115e30;
      --green: #1b7a3c;
      --green-light: #e8f6ee;
      --accent: #f6b900;
      --danger: #c62828;
      --bg: #f4f5f7;
      --text-main: #222;
      --muted: #6b7280;
      --card-radius: 18px;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: var(--bg);
      color: var(--text-main);
    }

    .app {
      max-width: 960px;
      margin: 0 auto;
      padding: 12px 12px 24px;
    }

    header.app-header {
      background: linear-gradient(135deg, var(--green-dark), var(--green));
      color: #fff;
      padding: 16px 18px 18px;
      border-radius: 0 0 24px 24px;
      margin: -12px -12px 12px;
      box-shadow: 0 4px 18px rgba(0, 0, 0, 0.35);
    }

    header.app-header h1 {
      margin: 0;
      font-size: 1.4rem;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    header.app-header h1 span.emoji {
      font-size: 1.5rem;
    }

    header.app-header p {
      margin: 6px 0 0;
      font-size: 0.9rem;
      opacity: 0.92;
    }

    header .status-row {
      margin-top: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      font-size: 0.8rem;
    }

    .status-pill {
      padding: 3px 9px;
      border-radius: 999px;
      background: rgba(255, 255, 255, 0.12);
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: #16a34a;
      box-shadow: 0 0 0 4px rgba(22, 163, 74, 0.3);
    }

    .status-pill.error .status-dot {
      background: #f97316;
      box-shadow: 0 0 0 4px rgba(248, 113, 22, 0.3);
    }

    .status-text {
      font-size: 0.8rem;
    }

    .status-tracking {
      text-align: right;
      font-size: 0.78rem;
      opacity: 0.9;
    }

    main {
      display: grid;
      grid-template-columns: minmax(0, 1.2fr) minmax(0, 1.1fr);
      gap: 12px;
    }

    @media (max-width: 800px) {
      main {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .card {
      background: #fff;
      border-radius: var(--card-radius);
      padding: 12px 12px 14px;
      box-shadow: 0 8px 20px rgba(15, 23, 42, 0.12);
    }

    .card h2 {
      margin: 0 0 10px;
      font-size: 1rem;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .card h3 {
      margin: 0 0 8px;
      font-size: 0.9rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .card small {
      font-size: 0.78rem;
      color: var(--muted);
    }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 2px 8px;
      border-radius: 999px;
      background: var(--green-light);
      color: var(--green-dark);
      font-size: 0.72rem;
      font-weight: 600;
    }

    .controls-row {
      display: flex;
      gap: 8px;
      margin-bottom: 8px;
      flex-wrap: wrap;
    }

    .btn {
      border: none;
      border-radius: 999px;
      padding: 8px 14px;
      font-size: 0.9rem;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
      transition: transform 0.08s ease, box-shadow 0.08s ease, background 0.08s ease;
      white-space: nowrap;
    }

    .btn span.icon {
      font-size: 1.1rem;
    }

    .btn-primary {
      background: #16a34a;
      color: #fff;
      box-shadow: 0 4px 12px rgba(22, 163, 74, 0.4);
    }

    .btn-primary:active {
      transform: translateY(1px);
      box-shadow: 0 2px 8px rgba(22, 163, 74, 0.35);
    }

    .btn-danger {
      background: var(--danger);
      color: #fff;
      box-shadow: 0 4px 12px rgba(198, 40, 40, 0.4);
    }

    .btn-outline {
      background: #fff;
      color: var(--green-dark);
      border: 1px solid rgba(15, 23, 42, 0.08);
    }

    .btn-outline:active {
      transform: translateY(1px);
      box-shadow: 0 2px 5px rgba(15, 23, 42, 0.12);
    }

    .btn-sm {
      padding: 4px 9px;
      font-size: 0.78rem;
      border-radius: 999px;
    }

    .btn-icon {
      padding: 7px 9px;
      border-radius: 999px;
    }

    .btn[disabled] {
      opacity: 0.55;
      cursor: default;
      box-shadow: none;
      transform: none;
    }

    .pill-state {
      font-size: 0.78rem;
      padding: 2px 8px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.05);
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .pill-dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: #9ca3af;
    }

    .pill-state.active .pill-dot {
      background: #22c55e;
    }

    .pill-state.idle .pill-dot {
      background: #9ca3af;
    }

    .pill-state span.label {
      text-transform: uppercase;
      font-weight: 600;
      letter-spacing: 0.06em;
    }

    .field-group {
      margin-bottom: 8px;
    }

    .field-group label {
      font-size: 0.78rem;
      font-weight: 600;
      color: #4b5563;
      display: flex;
      align-items: center;
      gap: 6px;
      margin-bottom: 3px;
    }

    .field-group small {
      font-size: 0.75rem;
    }

    input[type="text"],
    select {
      width: 100%;
      padding: 7px 10px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.9);
      font-size: 0.85rem;
      outline: none;
      transition: border 0.08s ease, box-shadow 0.08s ease, background 0.08s ease;
      background: #f9fafb;
    }

    input[type="text"]:focus,
    select:focus {
      border-color: #16a34a;
      box-shadow: 0 0 0 2px rgba(34, 197, 94, 0.25);
      background: #fff;
    }

    select {
      appearance: none;
      background-image: linear-gradient(45deg, transparent 50%, #6b7280 50%),
        linear-gradient(135deg, #6b7280 50%, transparent 50%);
      background-position: calc(100% - 14px) calc(50% - 3px),
        calc(100% - 9px) calc(50% - 3px);
      background-size: 6px 6px, 6px 6px;
      background-repeat: no-repeat;
    }

    .info-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 6px;
      margin-top: 6px;
    }

    .info-item {
      background: #f9fafb;
      border-radius: 999px;
      padding: 6px 9px;
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 0.75rem;
    }

    .info-item span.key {
      color: var(--muted);
      font-weight: 500;
    }

    .info-item span.value {
      font-weight: 600;
    }

    #map {
      width: 100%;
      height: 380px;
      border-radius: 16px;
      overflow: hidden;
    }

    @media (max-width: 480px) {
      #map {
        height: 330px;
      }
    }

    .map-toolbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
      gap: 8px;
      font-size: 0.8rem;
    }

    .map-toolbar-left {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .map-tag {
      background: #f3f4f6;
      border-radius: 999px;
      padding: 3px 9px;
      font-size: 0.75rem;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      color: #4b5563;
    }

    .map-tag span.bullet {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: #0ea5e9;
    }

    .map-toolbar-right {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .map-toolbar-right .btn-icon {
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.8);
      background: #fff;
      font-size: 0.8rem;
      padding: 4px 7px;
    }

    .map-toolbar-right .btn-icon span.icon {
      font-size: 1rem;
    }

    .map-toolbar-right small {
      color: var(--muted);
      font-size: 0.72rem;
    }

    .route-list {
      max-height: 200px;
      overflow-y: auto;
      padding-right: 2px;
    }

    .route-empty {
      font-size: 0.8rem;
      color: var(--muted);
      padding: 4px 0 2px;
    }

    .route-meta {
      font-size: 0.78rem;
      color: var(--muted);
    }

    .route-meta strong {
      color: #111827;
      font-weight: 600;
    }

    .route-actions {
      display: flex;
      gap: 6px;
      margin-top: 6px;
      justify-content: flex-end;
      flex-wrap: wrap;
    }

    .tag {
      font-size: 0.72rem;
      padding: 1px 7px;
      border-radius: 999px;
      background: #eef2ff;
      color: #4338ca;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .tag span.dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: #4f46e5;
    }

    .trap-list {
      margin-top: 4px;
      max-height: 210px;
      overflow-y: auto;
      border-radius: 14px;
      background: #f9fafb;
      padding: 6px 6px 6px 8px;
    }

    .trap-empty {
      font-size: 0.78rem;
      color: var(--muted);
      padding: 2px 2px 4px;
    }

    .trap-item {
      display: grid;
      grid-template-columns: minmax(0, 1fr) auto;
      gap: 6px;
      padding: 6px 4px;
      border-bottom: 1px dashed rgba(148, 163, 184, 0.7);
      font-size: 0.78rem;
      align-items: center;
    }

    .trap-item:last-child {
      border-bottom: none;
    }

    .trap-main {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .trap-title {
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .trap-title .badge {
      background: #fce7f3;
      color: #9d174d;
      font-size: 0.72rem;
    }

    .trap-sub {
      color: var(--muted);
    }

    .trap-note {
      color: #4b5563;
      font-style: italic;
    }

    .trap-actions {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .photo-thumb {
      width: 52px;
      height: 52px;
      object-fit: cover;
      border-radius: 12px;
      cursor: pointer;
      border: 2px solid #e5e7eb;
      box-shadow: 0 4px 8px rgba(148, 163, 184, 0.5);
      transition: transform 0.08s ease, box-shadow 0.08s ease;
    }

    .photo-thumb:hover {
      transform: translateY(-1px);
      box-shadow: 0 5px 14px rgba(148, 163, 184, 0.7);
    }

    .photo-modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.78);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .photo-modal-backdrop.active {
      display: flex;
    }

    .photo-modal {
      max-width: 95vw;
      max-height: 85vh;
      border-radius: 18px;
      background: #0b1120;
      padding: 8px;
      position: relative;
      box-shadow: 0 25px 60px rgba(0, 0, 0, 0.6);
    }

    .photo-modal img {
      max-width: 100%;
      max-height: 80vh;
      display: block;
      border-radius: 12px;
    }

    .photo-modal button.close {
      position: absolute;
      top: 8px;
      right: 8px;
      border-radius: 999px;
      border: none;
      background: rgba(15, 23, 42, 0.85);
      color: #e5e7eb;
      padding: 4px 8px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-size: 0.76rem;
    }

    .photo-modal button.close span.icon {
      font-size: 1rem;
    }

    footer {
      margin-top: 12px;
      font-size: 0.72rem;
      color: var(--muted);
      text-align: center;
    }

    footer a {
      color: var(--muted);
      text-decoration: underline dotted;
    }
  </style>
</head>
<body>
  <div class="app">
    <header class="app-header">
      <h1>
        <span class="emoji">üêù</span>
        Ninhos de Abelhas ‚Äì Rastreador
      </h1>
      <p>Registre seus trajetos, marque ninhos com foto e consulte depois.</p>

      <div class="status-row">
        <div class="status-pill" id="cloudStatus">
          <span class="status-dot"></span>
          <span class="status-text">Conectado √† nuvem (Supabase)</span>
        </div>
        <div class="status-tracking">
          <div id="trackingStateText">Trajeto n√£o iniciado</div>
          <div id="status" style="opacity: 0.8">Pronto para iniciar um novo trajeto.</div>
        </div>
      </div>
    </header>

    <main>
      <!-- Painel esquerdo: controles e lista -->
      <section class="card">
        <h2>
          <span>üéÆ</span> Controles do trajeto
          <span class="badge">
            <span>GPS</span><span>ativo</span>
          </span>
        </h2>

        <div class="controls-row">
          <button id="btnStart" class="btn btn-primary">
            <span class="icon">‚ñ∂Ô∏è</span>
            <span id="btnStartLabel">Iniciar trajeto</span>
          </button>

          <button id="btnStop" class="btn btn-danger" disabled>
            <span class="icon">‚èπÔ∏è</span>
            Encerrar trajeto
          </button>

          <button id="btnMarkTrap" class="btn btn-outline" disabled>
            <span class="icon">üìç</span>
            Marcar ninho
          </button>
        </div>

        <div class="pill-state idle" id="trackingPill">
          <span class="pill-dot"></span>
          <span class="label">Trajeto parado</span>
        </div>

        <div class="field-group" style="margin-top: 8px">
          <label for="routeNameInput">
            Nome do trajeto
            <small>(ex.: ‚ÄúMata do rio ‚Äì manh√£‚Äù)</small>
          </label>
          <input
            type="text"
            id="routeNameInput"
            placeholder="Defina um nome quando iniciar o trajeto"
          />
        </div>

        <div class="info-grid" id="currentInfo">
          <div class="info-item">
            <span class="key">Ninhos neste trajeto:</span>
            <span class="value" id="infoTrapCount">0</span>
          </div>
          <div class="info-item">
            <span class="key">Pontos GPS:</span>
            <span class="value" id="infoPointCount">0</span>
          </div>
        </div>

        <hr style="border: none; border-top: 1px dashed #e5e7eb; margin: 10px 0" />

        <h3>
          <span>üó∫Ô∏è</span> Trajetos salvos
          <span class="badge" id="routeCountBadge">0 trajetos</span>
        </h3>

        <div class="field-group">
          <label for="routeSelect">
            Selecione um trajeto para visualizar
          </label>
          <select id="routeSelect">
            <option value="">Nenhum trajeto selecionado</option>
          </select>
        </div>

        <div class="route-list" id="routeListContainer">
          <div class="route-empty" id="routeEmptyMsg">
            Nenhum trajeto salvo ainda. Inicie um trajeto para registrar sua
            primeira rota.
          </div>
        </div>
      </section>

      <!-- Painel direito: mapa e ninhos -->
      <section class="card">
        <div class="map-toolbar">
          <div class="map-toolbar-left">
            <div class="map-tag">
              <span class="bullet"></span>
              <span id="mapTagText">Mapa centrado na sua posi√ß√£o</span>
            </div>
          </div>
          <div class="map-toolbar-right">
            <button id="btnCenterOnUser" class="btn-icon" title="Centralizar em mim">
              <span class="icon">üéØ</span>
            </button>
            <small id="gpsHint">Use o bot√£o üéØ para recentrar no seu ponto.</small>
          </div>
        </div>

        <div id="map"></div>

        <div style="margin-top: 10px">
          <h3>
            <span>üêù</span> Ninhos deste trajeto
          </h3>
          <div class="trap-list" id="trapListContainer">
            <div class="trap-empty" id="trapEmptyMsg">
              Nenhum ninho marcado neste trajeto.
            </div>
          </div>
        </div>
      </section>
    </main>

    <footer>
      <div>Dados sincronizados com Supabase (trajetos e ninhos).</div>
      <div>
        Este app √© experimental. Sempre confirme os ninhos em campo.
      </div>
    </footer>
  </div>

  <!-- Modal de foto ampliada -->
  <div class="photo-modal-backdrop" id="photoModalBackdrop">
    <div class="photo-modal">
      <button class="close" id="photoModalClose">
        <span class="icon">‚úñÔ∏è</span>
        Fechar
      </button>
      <img id="photoModalImg" src="" alt="Foto do ninho ampliada" />
    </div>
  </div>

  <!-- Input oculto de foto -->
  <input
    type="file"
    id="photoInput"
    accept="image/*"
    capture="environment"
    style="display: none"
  />

  <!-- Leaflet JS -->
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <!-- Supabase JS (v2) -->
  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

    // üîß PREENCHA COM OS SEUS DADOS DO SUPABASE
    const SUPABASE_URL = "https://SEU_PROJETO.supabase.co";
    const SUPABASE_ANON_KEY = "SUA_ANON_KEY_AQUI";

    // Bucket de fotos
    const BUCKET_NAME = "ninhos-fotos";

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // ======= ESTADO GLOBAL =======
    let map;
    let userMarker;
    let routeLayerGroup;
    let trapsLayerGroup;
    let watchId = null;
    let lastPosition = null;

    let routes = []; // rotas vindas do Supabase
    let currentRoute = null; // rota em grava√ß√£o
    let pendingTrapPosition = null;

    const monitorState = {
      routeId: null,
      trapIndex: 0,
    };

    // ======= ELEMENTOS DO DOM =======
    const btnStart = document.getElementById("btnStart");
    const btnStop = document.getElementById("btnStop");
    const btnMarkTrap = document.getElementById("btnMarkTrap");
    const routeNameInput = document.getElementById("routeNameInput");
    const infoTrapCount = document.getElementById("infoTrapCount");
    const infoPointCount = document.getElementById("infoPointCount");
    const trackingPill = document.getElementById("trackingPill");
    const trackingStateText = document.getElementById("trackingStateText");
    const statusEl = document.getElementById("status");
    const routeSelect = document.getElementById("routeSelect");
    const routeListContainer = document.getElementById("routeListContainer");
    const routeEmptyMsg = document.getElementById("routeEmptyMsg");
    const routeCountBadge = document.getElementById("routeCountBadge");
    const trapListContainer = document.getElementById("trapListContainer");
    const trapEmptyMsg = document.getElementById("trapEmptyMsg");
    const photoInput = document.getElementById("photoInput");
    const cloudStatus = document.getElementById("cloudStatus");
    const mapTagText = document.getElementById("mapTagText");
    const btnCenterOnUser = document.getElementById("btnCenterOnUser");

    const photoModalBackdrop = document.getElementById("photoModalBackdrop");
    const photoModalImg = document.getElementById("photoModalImg");
    const photoModalClose = document.getElementById("photoModalClose");

    // ======= INICIALIZA√á√ÉO =======

    function initMap() {
      map = L.map("map");

      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 19,
        attribution: '&copy; OpenStreetMap contribuidores',
      }).addTo(map);

      routeLayerGroup = L.layerGroup().addTo(map);
      trapsLayerGroup = L.layerGroup().addTo(map);

      // Tenta centralizar na localiza√ß√£o do usu√°rio
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          (pos) => {
            const { latitude, longitude } = pos.coords;
            const latlng = [latitude, longitude];
            map.setView(latlng, 17);

            if (!userMarker) {
              userMarker = L.marker(latlng, {
                title: "Voc√™ est√° aqui",
              }).addTo(map);
            } else {
              userMarker.setLatLng(latlng);
            }
            lastPosition = { lat: latitude, lng: longitude };
            mapTagText.textContent = "Mapa centrado na sua posi√ß√£o";
          },
          () => {
            // fallback
            map.setView([-15.601, -56.097], 5);
            mapTagText.textContent = "Mapa geral ‚Äì ative o GPS para centralizar";
          },
          { enableHighAccuracy: true, timeout: 8000 }
        );
      } else {
        map.setView([-15.601, -56.097], 5);
        mapTagText.textContent = "Mapa geral ‚Äì GPS n√£o dispon√≠vel";
      }
    }

    // ======= SUPABASE: STORAGE (FOTOS) =======

    async function uploadTrapPhotoToSupabase(file, routeId) {
      const ext =
        file.name && file.name.includes(".")
          ? file.name.split(".").pop()
          : "jpg";

      const safeRouteId = routeId || "sem-rota";
      const path = `${safeRouteId}/${Date.now()}_${Math.random()
        .toString(36)
        .slice(2)}.${ext}`;

      const { data, error } = await supabase.storage
        .from(BUCKET_NAME)
        .upload(path, file, {
          contentType: file.type || "image/jpeg",
          cacheControl: "3600",
          upsert: false,
        });

      if (error) {
        console.error("Erro ao enviar foto para Storage:", error);
        throw error;
      }

      const { data: publicData } = supabase.storage
        .from(BUCKET_NAME)
        .getPublicUrl(data.path);

      return publicData.publicUrl;
    }

    // ======= SUPABASE: ROTAS =======

    async function saveRouteToSupabase(route) {
      console.log("Salvando rota no Supabase:", route);
      const { data, error } = await supabase
        .from("routes")
        .insert({
          name: route.name,
          created_at: route.createdAt,
          path: route.path,
          traps: route.traps,
        })
        .select()
        .single();

      if (error) {
        console.error("Erro ao salvar rota no Supabase:", error);
        alert("Erro ao salvar trajeto na nuvem:\n" + error.message);
        return false;
      }

      route.id = data.id; // uuid gerado no banco
      console.log("Rota salva com sucesso:", data);
      return true;
    }

    async function loadRoutesFromSupabase() {
      const { data, error } = await supabase
        .from("routes")
        .select("*")
        .order("created_at", { ascending: false });

      if (error) {
        console.error("Erro ao carregar rotas do Supabase:", error);
        cloudStatus.classList.add("error");
        cloudStatus.querySelector(".status-text").textContent =
          "Erro ao conectar √† nuvem";
        return;
      }

      cloudStatus.classList.remove("error");
      cloudStatus.querySelector(".status-text").textContent =
        "Conectado √† nuvem (Supabase)";

      routes = (data || []).map((r) => ({
        id: r.id,
        name: r.name || "Trajeto sem nome",
        createdAt: r.created_at,
        path: r.path || [],
        traps: (r.traps || []).map((t) => ({
          id: t.id,
          lat: t.lat,
          lng: t.lng,
          timestamp: t.timestamp,
          note: t.note,
          photoUrl: t.photoUrl || null,
          photo: t.photo || null,
        })),
      }));

      renderRouteSelect();
      renderRouteList();
    }

    async function updateRouteNameInSupabase(routeId, newName) {
      const { error } = await supabase
        .from("routes")
        .update({ name: newName })
        .eq("id", routeId);

      if (error) {
        console.error("Erro ao renomear rota:", error);
        alert("N√£o foi poss√≠vel renomear o trajeto na nuvem.");
      }
    }

    async function deleteRouteInSupabase(routeId) {
      const { error } = await supabase.from("routes").delete().eq("id", routeId);
      if (error) {
        console.error("Erro ao excluir rota:", error);
        alert("N√£o foi poss√≠vel excluir o trajeto na nuvem.");
      }
    }

    // ======= CONTROLE DE TRAJETO =======

    function startTracking() {
      if (!navigator.geolocation) {
        alert("Seu navegador n√£o suporta geolocaliza√ß√£o.");
        return;
      }

      if (watchId != null) {
        return;
      }

      let name = routeNameInput.value.trim();
      if (!name) {
        name = prompt("Nome do trajeto:", "Trilha de ninhos") || "";
        name = name.trim();
      }
      if (!name) {
        alert("Defina um nome para o trajeto.");
        return;
      }

      currentRoute = {
        id: "route_" + Date.now(),
        name,
        createdAt: new Date().toISOString(),
        path: [],
        traps: [],
      };

      routeNameInput.value = name;
      infoTrapCount.textContent = "0";
      infoPointCount.textContent = "0";

      watchId = navigator.geolocation.watchPosition(
        handlePositionUpdate,
        handlePositionError,
        {
          enableHighAccuracy: true,
          maximumAge: 2000,
          timeout: 10000,
        }
      );

      btnStart.disabled = true;
      btnStop.disabled = false;
      btnMarkTrap.disabled = false;

      trackingPill.classList.remove("idle");
      trackingPill.classList.add("active");
      trackingPill.querySelector(".label").textContent = "Gravando trajeto";

      trackingStateText.textContent = "Trajeto em andamento";
      statusEl.textContent =
        "Gravando seu deslocamento‚Ä¶ Marque ninhos quando encontrar pontos de interesse.";
    }

    function handlePositionUpdate(pos) {
      const { latitude, longitude } = pos.coords;
      const latlng = [latitude, longitude];

      lastPosition = { lat: latitude, lng: longitude };

      currentRoute?.path.push({
        lat: latitude,
        lng: longitude,
        timestamp: new Date().toISOString(),
      });

      infoPointCount.textContent = String(currentRoute?.path.length || 0);

      if (userMarker) {
        userMarker.setLatLng(latlng);
      } else {
        userMarker = L.marker(latlng, { title: "Voc√™ est√° aqui" }).addTo(map);
      }

      if (currentRoute?.path.length <= 2) {
        map.setView(latlng, 17);
        mapTagText.textContent = "Mapa centrado na sua posi√ß√£o";
      }

      renderCurrentRouteOnMap();
    }

    function handlePositionError(err) {
      console.error("Erro no GPS:", err);
      statusEl.textContent =
        "Erro ao obter localiza√ß√£o. Verifique as permiss√µes de GPS.";
    }

    function renderCurrentRouteOnMap() {
      routeLayerGroup.clearLayers();

      if (!currentRoute || currentRoute.path.length < 2) return;

      const latlngs = currentRoute.path.map((p) => [p.lat, p.lng]);
      L.polyline(latlngs, {
        color: "#16a34a",
        weight: 4,
      }).addTo(routeLayerGroup);
    }

    async function stopTracking() {
      if (watchId != null && navigator.geolocation) {
        navigator.geolocation.clearWatch(watchId);
        watchId = null;
      }

      btnStart.disabled = false;
      btnStop.disabled = true;
      btnMarkTrap.disabled = true;

      trackingPill.classList.remove("active");
      trackingPill.classList.add("idle");
      trackingPill.querySelector(".label").textContent = "Trajeto parado";

      trackingStateText.textContent = "Trajeto encerrado";

      if (currentRoute && currentRoute.path.length > 0) {
        const ok = await saveRouteToSupabase(currentRoute);

        if (!ok) {
          statusEl.textContent =
            "Trajeto encerrado (n√£o foi salvo na nuvem).";
          return;
        }

        await loadRoutesFromSupabase();

        routeSelect.value = currentRoute.id;
        const route = findRouteById(currentRoute.id);
        if (route) {
          showRouteOnMap(route);
          updateRouteInfo(route);
          renderTrapList(route);
        }

        alert("Trajeto salvo com sucesso na nuvem!");
      } else {
        alert("Nenhum ponto foi registrado. Trajeto n√£o ser√° salvo.");
      }

      currentRoute = null;
      statusEl.textContent =
        "Pronto para iniciar um novo trajeto quando desejar.";
    }

    // ======= NINHOS (TRAPS) =======

    function requestMarkTrap() {
      if (!currentRoute && !monitorState.routeId) {
        alert("Inicie um trajeto para marcar ninhos.");
        return;
      }

      if (!lastPosition) {
        alert("Ainda n√£o temos sua posi√ß√£o atual. Aguarde alguns segundos.");
        return;
      }

      pendingTrapPosition = { ...lastPosition };
      photoInput.click();
    }

    async function handlePhotoSelected(event) {
      const file = event.target.files[0];
      if (!pendingTrapPosition) {
        event.target.value = "";
        return;
      }

      const note =
        prompt("Alguma observa√ß√£o sobre este ninho? (opcional)", "") || "";

      if (!file) {
        registerTrap(
          pendingTrapPosition.lat,
          pendingTrapPosition.lng,
          null,
          note,
          false
        );
        pendingTrapPosition = null;
        return;
      }

      try {
        const routeId = currentRoute ? currentRoute.id : null;
        const photoUrl = await uploadTrapPhotoToSupabase(file, routeId);

        registerTrap(
          pendingTrapPosition.lat,
          pendingTrapPosition.lng,
          photoUrl,
          note,
          true
        );
      } catch (err) {
        alert(
          "N√£o foi poss√≠vel enviar a foto para a nuvem. O ninho ser√° salvo com a foto apenas local."
        );

        const reader = new FileReader();
        reader.onload = function (e) {
          const photoDataUrl = e.target.result;
          registerTrap(
            pendingTrapPosition.lat,
            pendingTrapPosition.lng,
            photoDataUrl,
            note,
            false
          );
        };
        reader.readAsDataURL(file);
      } finally {
        pendingTrapPosition = null;
        event.target.value = "";
      }
    }

    function registerTrap(lat, lng, photoRef, note, isUrl) {
      if (!currentRoute && !monitorState.routeId) {
        return;
      }

      if (currentRoute) {
        const trap = {
          id: "trap_" + Date.now(),
          lat,
          lng,
          timestamp: new Date().toISOString(),
          note,
          photoUrl: isUrl ? photoRef : null,
          photo: !isUrl ? photoRef : null,
        };

        currentRoute.traps.push(trap);
        infoTrapCount.textContent = String(currentRoute.traps.length);

        const popupHtml = createTrapPopupHtml(trap);
        const marker = L.marker([lat, lng]).addTo(trapsLayerGroup);
        marker.bindPopup(popupHtml);

        renderTrapList(currentRoute);

        alert("Ponto de ninho registrado!");
        return;
      }

      // (Futuro: adicionar ninho em rota monitorada)
    }

    function createTrapPopupHtml(trap) {
      const dt = formatDateTime(new Date(trap.timestamp));
      let html = `<div><strong>Ninho</strong><br/><small>${dt}</small>`;
      if (trap.note) {
        html += `<br/><em>${escapeHtml(trap.note)}</em>`;
      }

      const photoSrc = trap.photoUrl || trap.photo;
      if (photoSrc) {
        html += `<br/><img src="${photoSrc}" alt="Foto do ninho" style="max-width:120px;max-height:90px;margin-top:4px;border-radius:6px;" />`;
      }

      html += `</div>`;
      return html;
    }

    function renderTrapList(route) {
      trapListContainer.innerHTML = "";
      const traps = route?.traps || [];

      if (!traps.length) {
        trapListContainer.appendChild(trapEmptyMsg);
        trapEmptyMsg.style.display = "block";
        return;
      }
      trapEmptyMsg.style.display = "none";

      traps.forEach((trap, idx) => {
        const item = document.createElement("div");
        item.className = "trap-item";

        const main = document.createElement("div");
        main.className = "trap-main";

        const title = document.createElement("div");
        title.className = "trap-title";
        title.innerHTML = `<span class="badge">Ninho #${idx + 1}</span>`;

        const dt = formatDateTime(new Date(trap.timestamp));
        const sub = document.createElement("div");
        sub.className = "trap-sub";
        sub.textContent = `Registrado em ${dt}`;

        main.appendChild(title);
        main.appendChild(sub);

        if (trap.note) {
          const noteEl = document.createElement("div");
          noteEl.className = "trap-note";
          noteEl.textContent = `‚Äú${trap.note}‚Äù`;
          main.appendChild(noteEl);
        }

        const actions = document.createElement("div");
        actions.className = "trap-actions";

        const photoSrc = trap.photoUrl || trap.photo;
        if (photoSrc) {
          const img = document.createElement("img");
          img.src = photoSrc;
          img.alt = "Foto do ninho";
          img.className = "photo-thumb";
          img.addEventListener("click", () => {
            openPhotoModal(photoSrc);
          });
          actions.appendChild(img);
        }

        const focusBtn = document.createElement("button");
        focusBtn.className = "btn btn-sm btn-outline";
        focusBtn.innerHTML = '<span class="icon">üéØ</span> Ver no mapa';
        focusBtn.addEventListener("click", () => {
          map.setView([trap.lat, trap.lng], 18);
        });
        actions.appendChild(focusBtn);

        item.appendChild(main);
        item.appendChild(actions);

        trapListContainer.appendChild(item);
      });
    }

    function openPhotoModal(src) {
      photoModalImg.src = src;
      photoModalBackdrop.classList.add("active");
    }

    function closePhotoModal() {
      photoModalBackdrop.classList.remove("active");
      photoModalImg.src = "";
    }

    // ======= LISTAGEM DE ROTAS =======

    function renderRouteSelect() {
      const selectedId = routeSelect.value;
      routeSelect.innerHTML = "";

      const emptyOption = document.createElement("option");
      emptyOption.value = "";
      emptyOption.textContent = "Selecione um trajeto";
      routeSelect.appendChild(emptyOption);

      routes.forEach((route) => {
        const opt = document.createElement("option");
        opt.value = route.id;
        opt.textContent = `${route.name} (${formatShortDate(route.createdAt)})`;
        routeSelect.appendChild(opt);
      });

      if (selectedId && routes.some((r) => r.id === selectedId)) {
        routeSelect.value = selectedId;
      }

      routeCountBadge.textContent = `${routes.length} trajeto${
        routes.length === 1 ? "" : "s"
      }`;
    }

    function renderRouteList() {
      routeListContainer.innerHTML = "";

      if (!routes.length) {
        routeListContainer.appendChild(routeEmptyMsg);
        routeEmptyMsg.style.display = "block";
        return;
      }
      routeEmptyMsg.style.display = "none";

      routes.forEach((route) => {
        const wrapper = document.createElement("div");
        wrapper.style.padding = "5px 2px 6px";
        wrapper.style.borderBottom = "1px dashed #e5e7eb";

        const titleRow = document.createElement("div");
        titleRow.style.display = "flex";
        titleRow.style.justifyContent = "space-between";
        titleRow.style.alignItems = "center";
        titleRow.style.gap = "6px";

        const left = document.createElement("div");
        left.style.display = "flex";
        left.style.flexDirection = "column";
        left.style.gap = "2px";

        const title = document.createElement("div");
        title.style.fontWeight = "600";
        title.style.fontSize = "0.85rem";
        title.textContent = route.name;

        const meta = document.createElement("div");
        meta.className = "route-meta";
        const dt = formatDateTime(new Date(route.createdAt));
        meta.innerHTML = `<strong>${dt}</strong> ¬∑ ${
          route.traps.length
        } ninhos ¬∑ ${route.path.length} pontos`;

        left.appendChild(title);
        left.appendChild(meta);

        const rightTag = document.createElement("div");
        rightTag.className = "tag";
        rightTag.innerHTML = `<span class="dot"></span> ${
          route.traps.length ? "Com ninhos" : "Sem ninhos"
        }`;

        titleRow.appendChild(left);
        titleRow.appendChild(rightTag);

        const actions = document.createElement("div");
        actions.className = "route-actions";

        const viewBtn = document.createElement("button");
        viewBtn.className = "btn btn-sm btn-outline";
        viewBtn.innerHTML = '<span class="icon">üëÅÔ∏è</span> Ver';
        viewBtn.addEventListener("click", () => {
          routeSelect.value = route.id;
          handleRouteSelectionChange();
        });

        const renameBtn = document.createElement("button");
        renameBtn.className = "btn btn-sm btn-outline";
        renameBtn.innerHTML = '<span class="icon">‚úèÔ∏è</span> Renomear';
        renameBtn.addEventListener("click", () => {
          renameRoute(route.id);
        });

        const deleteBtn = document.createElement("button");
        deleteBtn.className = "btn btn-sm btn-outline";
        deleteBtn.style.borderColor = "rgba(220, 38, 38, 0.35)";
        deleteBtn.style.color = "#b91c1c";
        deleteBtn.innerHTML = '<span class="icon">üóëÔ∏è</span> Excluir';
        deleteBtn.addEventListener("click", () => {
          deleteRoute(route.id);
        });

        actions.appendChild(viewBtn);
        actions.appendChild(renameBtn);
        actions.appendChild(deleteBtn);

        wrapper.appendChild(titleRow);
        wrapper.appendChild(actions);

        routeListContainer.appendChild(wrapper);
      });
    }

    function findRouteById(id) {
      return routes.find((r) => r.id === id) || null;
    }

    function handleRouteSelectionChange() {
      const id = routeSelect.value;
      const route = findRouteById(id);
      if (!route) {
        routeNameInput.value = "";
        infoTrapCount.textContent = "0";
        infoPointCount.textContent = "0";
        trapsLayerGroup.clearLayers();
        routeLayerGroup.clearLayers();
        renderTrapList({ traps: [] });
        return;
      }

      showRouteOnMap(route);
      updateRouteInfo(route);
      renderTrapList(route);
    }

    function showRouteOnMap(route) {
      routeLayerGroup.clearLayers();
      trapsLayerGroup.clearLayers();

      if (route.path.length >= 2) {
        const latlngs = route.path.map((p) => [p.lat, p.lng]);
        const poly = L.polyline(latlngs, {
          color: "#16a34a",
          weight: 4,
        }).addTo(routeLayerGroup);
        map.fitBounds(poly.getBounds(), { padding: [20, 20] });
        mapTagText.textContent = "Exibindo trajeto salvo";
      }

      route.traps.forEach((trap) => {
        const marker = L.marker([trap.lat, trap.lng]).addTo(trapsLayerGroup);
        marker.bindPopup(createTrapPopupHtml(trap));
      });
    }

    function updateRouteInfo(route) {
      routeNameInput.value = route.name || "";
      infoTrapCount.textContent = String(route.traps.length);
      infoPointCount.textContent = String(route.path.length);
    }

    async function renameRoute(routeId) {
      const route = findRouteById(routeId);
      if (!route) return;

      const newName =
        prompt("Novo nome para o trajeto:", route.name || "") || "";
      const trimmed = newName.trim();
      if (!trimmed || trimmed === route.name) return;

      route.name = trimmed;
      await updateRouteNameInSupabase(routeId, trimmed);
      renderRouteSelect();
      renderRouteList();

      if (routeSelect.value === routeId) {
        routeNameInput.value = trimmed;
      }
    }

    async function deleteRoute(routeId) {
      const route = findRouteById(routeId);
      if (!route) return;

      const confirmDelete = confirm(
        `Tem certeza que deseja excluir o trajeto "${route.name}"? Esta a√ß√£o n√£o pode ser desfeita.`
      );
      if (!confirmDelete) return;

      await deleteRouteInSupabase(routeId);
      routes = routes.filter((r) => r.id !== routeId);

      if (routeSelect.value === routeId) {
        routeSelect.value = "";
        trapsLayerGroup.clearLayers();
        routeLayerGroup.clearLayers();
        routeNameInput.value = "";
        infoTrapCount.textContent = "0";
        infoPointCount.textContent = "0";
        renderTrapList({ traps: [] });
      }

      renderRouteSelect();
      renderRouteList();
    }

    // ======= UTILIT√ÅRIOS =======

    function formatDateTime(dt) {
      if (!dt) return "";
      const d = dt instanceof Date ? dt : new Date(dt);
      const dia = String(d.getDate()).padStart(2, "0");
      const mes = String(d.getMonth() + 1).padStart(2, "0");
      const ano = d.getFullYear();
      const hor = String(d.getHours()).padStart(2, "0");
      const min = String(d.getMinutes()).padStart(2, "0");
      return `${dia}/${mes}/${ano} ${hor}:${min}`;
    }

    function formatShortDate(dt) {
      if (!dt) return "";
      const d = dt instanceof Date ? dt : new Date(dt);
      const dia = String(d.getDate()).padStart(2, "0");
      const mes = String(d.getMonth() + 1).padStart(2, "0");
      return `${dia}/${mes}`;
    }

    function escapeHtml(str) {
      return String(str)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#39;");
    }

    // ======= EVENTOS =======

    btnStart.addEventListener("click", startTracking);
    btnStop.addEventListener("click", stopTracking);
    btnMarkTrap.addEventListener("click", requestMarkTrap);
    routeSelect.addEventListener("change", handleRouteSelectionChange);
    photoInput.addEventListener("change", handlePhotoSelected);
    btnCenterOnUser.addEventListener("click", () => {
      if (lastPosition) {
        map.setView([lastPosition.lat, lastPosition.lng], 17);
        mapTagText.textContent = "Mapa centrado na sua posi√ß√£o";
      } else {
        alert("Ainda n√£o foi poss√≠vel obter sua posi√ß√£o.");
      }
    });

    photoModalBackdrop.addEventListener("click", (e) => {
      if (e.target === photoModalBackdrop) {
        closePhotoModal();
      }
    });
    photoModalClose.addEventListener("click", closePhotoModal);

    // ======= BOOTSTRAP =======
    initMap();
    loadRoutesFromSupabase();
  </script>
</body>
</html>
